<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatCalc - Statistical Calculator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #f5f5f5;
            --container-bg: #ffffff;
            --container-shadow: 0 2px 12px rgba(0,0,0,0.08);
            --header-bg: #4f46e5;
            --header-bg-end: #6366f1;
            --header-text: #ffffff;
            --section-bg: #f8fafc;
            --section-border: #e2e8f0;
            --section-hover-border: #4f46e5;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --input-bg: #ffffff;
            --input-border: #e2e8f0;
            --input-focus: #4f46e5;
            --btn-bg: #4f46e5;
            --btn-bg-end: #6366f1;
            --btn-text: #ffffff;
            --btn-shadow: rgba(79, 70, 229, 0.25);
            --btn-secondary-bg: #f1f5f9;
            --btn-secondary-text: #475569;
            --btn-secondary-border: #e2e8f0;
            --results-bg: #ffffff;
            --results-border: #e2e8f0;
            --results-active-bg: #f0fdf4;
            --results-active-border: #10b981;
            --divider: #e2e8f0;
            --chart-bar: #4f46e5;
            --chart-axis: #94a3b8;
            --chart-label: #64748b;
            --select-bg: #ffffff;
            --tab-active-bg: #4f46e5;
            --tab-active-text: #ffffff;
            --tab-inactive-bg: #f1f5f9;
            --tab-inactive-text: #64748b;
            --tab-inactive-border: #e2e8f0;
            --scatter-point: #4f46e5;
            --scatter-line: #ef4444;
            --copy-success: #10b981;
        }
        
        [data-theme="dark"] {
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --container-bg: #1e1e2e;
            --container-shadow: 0 20px 40px rgba(0,0,0,0.3);
            --header-bg: #302060;
            --header-bg-end: #4a2080;
            --header-text: #ffffff;
            --section-bg: #2a2a3e;
            --section-border: #3a3a50;
            --section-hover-border: #7c6aef;
            --text-primary: #e2e8f0;
            --text-secondary: #b0b8c8;
            --text-muted: #8890a0;
            --input-bg: #1e1e2e;
            --input-border: #3a3a50;
            --input-focus: #7c6aef;
            --btn-bg: #6d5ae6;
            --btn-bg-end: #9b6aef;
            --btn-text: #ffffff;
            --btn-shadow: rgba(109, 90, 230, 0.35);
            --btn-secondary-bg: #2a2a3e;
            --btn-secondary-text: #b0b8c8;
            --btn-secondary-border: #3a3a50;
            --results-bg: #1e1e2e;
            --results-border: #3a3a50;
            --results-active-bg: #1a2e1a;
            --results-active-border: #10b981;
            --divider: #3a3a50;
            --chart-bar: #7c6aef;
            --chart-axis: #6a6a80;
            --chart-label: #8890a0;
            --select-bg: #1e1e2e;
            --tab-active-bg: #6d5ae6;
            --tab-active-text: #ffffff;
            --tab-inactive-bg: #2a2a3e;
            --tab-inactive-text: #8890a0;
            --tab-inactive-border: #3a3a50;
            --scatter-point: #7c6aef;
            --scatter-line: #ef4444;
            --copy-success: #10b981;
        }
        
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 16px;
            box-shadow: var(--container-shadow);
            overflow: hidden;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        
        .header {
            background: linear-gradient(135deg, var(--header-bg) 0%, var(--header-bg-end) 100%);
            color: var(--header-text);
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50px;
            width: 56px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 2px;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover { background: rgba(255,255,255,0.3); border-color: rgba(255,255,255,0.5); }
        
        .theme-toggle .toggle-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: transform 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        [data-theme="dark"] .theme-toggle .toggle-thumb { transform: translateX(26px); }
        
        .theme-toggle-label {
            position: absolute;
            top: 54px;
            right: 20px;
            color: rgba(255,255,255,0.7);
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.05em;
        }
        
        /* Tab navigation */
        .tab-nav {
            display: flex;
            gap: 4px;
            padding: 20px 40px 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: 2px solid var(--tab-inactive-border);
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            background: var(--tab-inactive-bg);
            color: var(--tab-inactive-text);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .tab-btn:hover { color: var(--text-primary); }
        
        .tab-btn.active {
            background: var(--tab-active-bg);
            color: var(--tab-active-text);
            border-color: var(--tab-active-bg);
        }
        
        .main { padding: 0 40px 40px; }
        
        .tab-content { display: none; padding-top: 30px; }
        .tab-content.active { display: block; }
        
        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }
        
        .calculator-grid.single { grid-template-columns: 1fr; max-width: 700px; }
        .calculator-grid.triple { grid-template-columns: 1fr 1fr 1fr; }
        
        @media (max-width: 900px) {
            .calculator-grid, .calculator-grid.triple { grid-template-columns: 1fr; gap: 30px; }
            .header h1 { font-size: 1.8rem; }
            .main { padding: 0 20px 20px; }
            .tab-nav { padding: 20px 20px 0; }
            .theme-toggle-label { display: none; }
            .tab-btn { padding: 8px 14px; font-size: 0.85rem; }
        }
        
        .calc-section {
            background: var(--section-bg);
            border-radius: 12px;
            padding: 30px;
            border: 2px solid var(--section-border);
            transition: all 0.3s ease;
        }
        
        .calc-section:hover { border-color: var(--section-hover-border); transform: translateY(-2px); }
        .calc-section.full-width { grid-column: 1 / -1; }
        
        .calc-section h3 {
            color: var(--text-primary);
            font-size: 1.3rem;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-group { margin-bottom: 20px; }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: border-color 0.2s ease, background 0.3s ease;
        }
        
        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--input-focus);
        }
        
        .input-group textarea {
            height: 100px;
            resize: vertical;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }
        
        .input-group select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
            cursor: pointer;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        @media (max-width: 500px) { .input-row { grid-template-columns: 1fr; } }
        
        .btn {
            background: linear-gradient(135deg, var(--btn-bg) 0%, var(--btn-bg-end) 100%);
            color: var(--btn-text);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px var(--btn-shadow); }
        .btn:active { transform: translateY(0); }
        
        .btn-secondary {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border: 1px solid var(--btn-secondary-border);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover { border-color: var(--input-focus); color: var(--input-focus); }
        
        .btn-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .results {
            margin-top: 20px;
            padding: 20px;
            background: var(--results-bg);
            border-radius: 8px;
            border: 2px solid var(--results-border);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .results.active { border-color: var(--results-active-border); background: var(--results-active-bg); }
        
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--btn-secondary-bg);
            border: 1px solid var(--btn-secondary-border);
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .copy-btn:hover { border-color: var(--input-focus); color: var(--input-focus); }
        .copy-btn.copied { border-color: var(--copy-success); color: var(--copy-success); }
        
        .stat-result {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--divider);
        }
        
        .stat-result:last-child { border-bottom: none; margin-bottom: 0; }
        
        .stat-label { color: var(--text-secondary); font-weight: 500; }
        
        .stat-value {
            color: var(--text-primary);
            font-weight: 600;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }
        
        .visualization { margin-top: 30px; text-align: center; }
        .chart { width: 100%; height: 300px; margin-top: 20px; }
        
        .helper-text {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.4;
        }
        
        .footer {
            text-align: center;
            padding: 20px 40px 30px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .footer a { color: var(--text-secondary); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        
        /* Example & Formula buttons */
        .example-btns {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        
        .example-btn {
            background: var(--btn-secondary-bg);
            color: var(--text-muted);
            border: 1px dashed var(--btn-secondary-border);
            padding: 4px 10px;
            border-radius: 14px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .example-btn:hover { border-color: var(--input-focus); color: var(--input-focus); border-style: solid; }
        
        .formula-box {
            background: var(--results-bg);
            border: 1px solid var(--divider);
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 12px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
            display: none;
        }
        
        .formula-box.visible { display: block; }
        
        .formula-box .formula-title {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }
        
        .formula-toggle {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: color 0.2s;
        }
        
        .formula-toggle:hover { color: var(--input-focus); }
        
        /* Contingency / comparison tables */
        .stat-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 13px;
        }
        
        .stat-table caption {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-align: left;
        }
        
        .stat-table th, .stat-table td {
            padding: 6px 10px;
            border: 1px solid var(--divider);
            text-align: center;
        }
        
        .stat-table th {
            background: var(--section-bg);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 12px;
        }
        
        .stat-table td {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            color: var(--text-primary);
        }
        
        .stat-table td.highlight {
            background: rgba(79, 70, 229, 0.08);
        }
        
        [data-theme="dark"] .stat-table td.highlight {
            background: rgba(124, 106, 239, 0.12);
        }
        
        .stat-table .total-cell {
            font-weight: 600;
            background: var(--section-bg);
        }
        
        /* Print styles */
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; border-radius: 0; }
            .header { background: none !important; color: #1e293b; padding: 20px; border-bottom: 2px solid #e2e8f0; }
            .header h1 { font-size: 1.8rem; }
            .theme-toggle, .theme-toggle-label { display: none; }
            .tab-nav { display: none; }
            .tab-content { display: block !important; padding-top: 20px; }
            .tab-content::before {
                content: attr(data-print-title);
                display: block;
                font-size: 1.4rem;
                font-weight: 700;
                margin-bottom: 16px;
                color: #1e293b;
                border-bottom: 2px solid #4f46e5;
                padding-bottom: 8px;
            }
            .calc-section { break-inside: avoid; border-color: #e2e8f0; }
            .calc-section:hover { transform: none; border-color: #e2e8f0; }
            .btn, .btn-secondary, .copy-btn, .example-btns, .formula-toggle { display: none; }
            .formula-box { display: block !important; border-color: #e2e8f0; background: #f8fafc; }
            .results { background: #f8fafc; border-color: #e2e8f0; }
            .results.active { background: #f0fdf4; border-color: #10b981; }
            .footer { border-top: 1px solid #e2e8f0; }
            canvas { max-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>StatCalc</h1>
            <p>Statistical calculations with clear visualizations</p>
            
            <div class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode" role="button" aria-label="Toggle theme">
                <div class="toggle-thumb" id="toggle-icon">‚òÄÔ∏è</div>
            </div>
            <div class="theme-toggle-label" id="theme-label">light mode</div>
        </div>
        
        <nav class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('basics')">üìä Basics</button>
            <button class="tab-btn" onclick="switchTab('tests')">üéØ Hypothesis Tests</button>
            <button class="tab-btn" onclick="switchTab('chisquare')">üé≤ Chi-Square</button>
            <button class="tab-btn" onclick="switchTab('anova')">üî¨ ANOVA</button>
            <button class="tab-btn" onclick="switchTab('regression')">üìà Regression</button>
            <button class="tab-btn" onclick="switchTab('power')">üìê Power & Sample Size</button>
        </nav>
        
        <div class="main">
            <!-- TAB 1: Basics -->
            <div id="tab-basics" class="tab-content active" data-print-title="Descriptive Statistics & Confidence Intervals">
                <div class="calculator-grid">
                    <!-- Descriptive Statistics -->
                    <div class="calc-section">
                        <h3>üìä Descriptive Statistics</h3>
                        <div class="example-btns">
                            <span style="font-size:11px;color:var(--text-muted);align-self:center">Try:</span>
                            <button class="example-btn" onclick="loadExample('desc-exam')">üìù Exam scores</button>
                            <button class="example-btn" onclick="loadExample('desc-heights')">üìè Heights</button>
                            <button class="example-btn" onclick="loadExample('desc-skewed')">üìä Skewed data</button>
                        </div>
                        <div class="input-group">
                            <label for="data-input">Enter your data (comma-separated or one per line):</label>
                            <textarea id="data-input" placeholder="1.2, 2.3, 3.1&#10;4.2&#10;5.0, 6.1"></textarea>
                        </div>
                        <div class="btn-row">
                            <button class="btn" onclick="calculateDescriptive()">Calculate Stats</button>
                            <button class="formula-toggle" onclick="toggleFormula('desc-formula')">üìê Show formulas</button>
                        </div>
                        <div id="desc-formula" class="formula-box">
                            <div class="formula-title">Formulas Used</div>
                            Mean: xÃÑ = Œ£x·µ¢ / n<br>
                            Variance: s¬≤ = Œ£(x·µ¢ ‚àí xÃÑ)¬≤ / (n ‚àí 1)<br>
                            Std Dev: s = ‚àös¬≤<br>
                            Skewness: g‚ÇÅ = [n/((n‚àí1)(n‚àí2))] ¬∑ Œ£[(x·µ¢‚àíxÃÑ)/s]¬≥<br>
                            IQR: Q3 ‚àí Q1 (linear interpolation)
                        </div>
                        
                        <div id="descriptive-results" class="results">
                            <button class="copy-btn" onclick="copyResults('descriptive-results')">üìã Copy</button>
                            <div class="stat-result"><span class="stat-label">Sample Size (n)</span><span class="stat-value" id="desc-n">-</span></div>
                            <div class="stat-result"><span class="stat-label">Mean (xÃÑ)</span><span class="stat-value" id="desc-mean">-</span></div>
                            <div class="stat-result"><span class="stat-label">Median</span><span class="stat-value" id="desc-median">-</span></div>
                            <div class="stat-result"><span class="stat-label">Standard Deviation (s)</span><span class="stat-value" id="desc-std">-</span></div>
                            <div class="stat-result"><span class="stat-label">Variance (s¬≤)</span><span class="stat-value" id="desc-var">-</span></div>
                            <div class="stat-result"><span class="stat-label">Min / Max</span><span class="stat-value" id="desc-range">-</span></div>
                            <div class="stat-result"><span class="stat-label">IQR (Q1 ‚Äì Q3)</span><span class="stat-value" id="desc-iqr">-</span></div>
                            <div class="stat-result"><span class="stat-label">Skewness</span><span class="stat-value" id="desc-skew">-</span></div>
                        </div>
                        
                        <div class="visualization">
                            <canvas id="histogram" class="chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Confidence Intervals -->
                    <div class="calc-section">
                        <h3>üìè Confidence Intervals</h3>
                        <div class="example-btns">
                            <span style="font-size:11px;color:var(--text-muted);align-self:center">Try:</span>
                            <button class="example-btn" onclick="loadExample('ci-textbook')">üìñ Textbook example</button>
                            <button class="example-btn" onclick="loadExample('ci-small')">üî¨ Small sample</button>
                        </div>
                        <div class="input-group">
                            <label for="ci-mean">Sample Mean (xÃÑ):</label>
                            <input type="number" id="ci-mean" step="any" placeholder="e.g., 23.5">
                        </div>
                        <div class="input-group">
                            <label for="ci-std">Sample Standard Deviation (s):</label>
                            <input type="number" id="ci-std" step="any" placeholder="e.g., 4.2">
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="ci-n">Sample Size (n):</label>
                                <input type="number" id="ci-n" placeholder="e.g., 30">
                            </div>
                            <div class="input-group">
                                <label for="ci-level">Confidence Level:</label>
                                <select id="ci-level">
                                    <option value="90">90%</option>
                                    <option value="95" selected>95%</option>
                                    <option value="99">99%</option>
                                </select>
                            </div>
                        </div>
                        <div class="btn-row">
                            <button class="btn" onclick="calculateCI()">Calculate CI</button>
                            <button class="btn-secondary" onclick="fillCIFromDescriptive()">‚Üê Fill from descriptive</button>
                            <button class="formula-toggle" onclick="toggleFormula('ci-formula')">üìê Show formulas</button>
                        </div>
                        <div id="ci-formula" class="formula-box">
                            <div class="formula-title">Formulas Used</div>
                            Standard Error: SE = s / ‚àön<br>
                            t-critical: t* from Student's t-distribution at df = n‚àí1<br>
                            Margin of Error: E = t* √ó SE<br>
                            Confidence Interval: xÃÑ ¬± E = [xÃÑ ‚àí E, xÃÑ + E]
                        </div>
                        
                        <div id="ci-results" class="results">
                            <button class="copy-btn" onclick="copyResults('ci-results')">üìã Copy</button>
                            <div class="stat-result"><span class="stat-label">Standard Error</span><span class="stat-value" id="ci-se">-</span></div>
                            <div class="stat-result"><span class="stat-label">t-critical value</span><span class="stat-value" id="ci-tcrit">-</span></div>
                            <div class="stat-result"><span class="stat-label">Margin of Error</span><span class="stat-value" id="ci-margin">-</span></div>
                            <div class="stat-result"><span class="stat-label">Lower Bound</span><span class="stat-value" id="ci-lower">-</span></div>
                            <div class="stat-result"><span class="stat-label">Upper Bound</span><span class="stat-value" id="ci-upper">-</span></div>
                            <div class="stat-result"><span class="stat-label">Confidence Interval</span><span class="stat-value" id="ci-interval">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB 2: Hypothesis Tests -->
            <div id="tab-tests" class="tab-content" data-print-title="Hypothesis Tests">
                <div class="calculator-grid">
                    <!-- One-Sample t-Test -->
                    <div class="calc-section">
                        <h3>üéØ One-Sample t-Test</h3>
                        <div class="example-btns">
                            <span style="font-size:11px;color:var(--text-muted);align-self:center">Try:</span>
                            <button class="example-btn" onclick="loadExample('t1-sig')">‚úì Significant result</button>
                            <button class="example-btn" onclick="loadExample('t1-nonsig')">‚úó Non-significant</button>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="t-mean">Sample Mean (xÃÑ):</label>
                                <input type="number" id="t-mean" step="any" placeholder="e.g., 23.5">
                            </div>
                            <div class="input-group">
                                <label for="t-std">Sample Std Dev (s):</label>
                                <input type="number" id="t-std" step="any" placeholder="e.g., 4.2">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="t-n">Sample Size (n):</label>
                                <input type="number" id="t-n" placeholder="e.g., 30">
                            </div>
                            <div class="input-group">
                                <label for="t-null">Null Hypothesis Mean (Œº‚ÇÄ):</label>
                                <input type="number" id="t-null" step="any" placeholder="e.g., 20.0">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="t-tail">Test Type:</label>
                            <select id="t-tail">
                                <option value="two" selected>Two-tailed (Œº ‚â† Œº‚ÇÄ)</option>
                                <option value="left">Left-tailed (Œº &lt; Œº‚ÇÄ)</option>
                                <option value="right">Right-tailed (Œº &gt; Œº‚ÇÄ)</option>
                            </select>
                        </div>
                        <div class="btn-row">
                        <button class="btn" onclick="calculateTTest()">Run t-Test</button>
                        <button class="formula-toggle" onclick="toggleFormula('t1-formula')">üìê Show formulas</button>
                        </div>
                        <div id="t1-formula" class="formula-box">
                            <div class="formula-title">Formulas Used</div>
                            t-statistic: t = (xÃÑ ‚àí Œº‚ÇÄ) / (s / ‚àön)<br>
                            Degrees of freedom: df = n ‚àí 1<br>
                            Cohen's d: d = |xÃÑ ‚àí Œº‚ÇÄ| / s<br>
                            p-value from Student's t-distribution
                        </div>
                        
                        <div id="ttest-results" class="results">
                            <button class="copy-btn" onclick="copyResults('ttest-results')">üìã Copy</button>
                            <div class="stat-result"><span class="stat-label">t-statistic</span><span class="stat-value" id="t-stat">-</span></div>
                            <div class="stat-result"><span class="stat-label">Degrees of Freedom</span><span class="stat-value" id="t-df">-</span></div>
                            <div class="stat-result"><span class="stat-label">p-value</span><span class="stat-value" id="t-pvalue">-</span></div>
                            <div class="stat-result"><span class="stat-label">Result (Œ± = 0.05)</span><span class="stat-value" id="t-result">-</span></div>
                            <div class="stat-result"><span class="stat-label">Effect Size (Cohen's d)</span><span class="stat-value" id="t-cohend">-</span></div>
                        </div>
                    </div>
                    
                    <!-- Two-Sample t-Test -->
                    <div class="calc-section">
                        <h3>‚öñÔ∏è Two-Sample t-Test</h3>
                        <div class="example-btns">
                            <span style="font-size:11px;color:var(--text-muted);align-self:center">Try:</span>
                            <button class="example-btn" onclick="loadExample('t2-drug')">üíä Drug trial</button>
                            <button class="example-btn" onclick="loadExample('t2-equal')">ü§ù Equal groups</button>
                        </div>
                        <p class="helper-text" style="margin-bottom:16px">Compare means of two independent groups (Welch's t-test, unequal variances).</p>
                        <div class="input-group">
                            <label for="t2-data1">Group 1 data (comma-separated or one per line):</label>
                            <textarea id="t2-data1" placeholder="5.2, 6.1, 4.8, 7.0, 5.5" style="height:70px"></textarea>
                        </div>
                        <div class="input-group">
                            <label for="t2-data2">Group 2 data:</label>
                            <textarea id="t2-data2" placeholder="3.8, 4.2, 5.1, 3.9, 4.5" style="height:70px"></textarea>
                        </div>
                        <div class="input-group">
                            <label for="t2-tail">Test Type:</label>
                            <select id="t2-tail">
                                <option value="two" selected>Two-tailed (Œº‚ÇÅ ‚â† Œº‚ÇÇ)</option>
                                <option value="left">Left-tailed (Œº‚ÇÅ &lt; Œº‚ÇÇ)</option>
                                <option value="right">Right-tailed (Œº‚ÇÅ &gt; Œº‚ÇÇ)</option>
                            </select>
                        </div>
                        <div class="btn-row">
                        <button class="btn" onclick="calculateTwoSampleT()">Run t-Test</button>
                        <button class="formula-toggle" onclick="toggleFormula('t2-formula')">üìê Show formulas</button>
                        </div>
                        <div id="t2-formula" class="formula-box">
                            <div class="formula-title">Formulas Used (Welch's t-test)</div>
                            t = (xÃÑ‚ÇÅ ‚àí xÃÑ‚ÇÇ) / ‚àö(s‚ÇÅ¬≤/n‚ÇÅ + s‚ÇÇ¬≤/n‚ÇÇ)<br>
                            df ‚âà (s‚ÇÅ¬≤/n‚ÇÅ + s‚ÇÇ¬≤/n‚ÇÇ)¬≤ / [(s‚ÇÅ¬≤/n‚ÇÅ)¬≤/(n‚ÇÅ‚àí1) + (s‚ÇÇ¬≤/n‚ÇÇ)¬≤/(n‚ÇÇ‚àí1)]<br>
                            Cohen's d = |xÃÑ‚ÇÅ ‚àí xÃÑ‚ÇÇ| / s‚Çö  where s‚Çö = ‚àö[((n‚ÇÅ‚àí1)s‚ÇÅ¬≤ + (n‚ÇÇ‚àí1)s‚ÇÇ¬≤) / (n‚ÇÅ+n‚ÇÇ‚àí2)]
                        </div>
                        
                        <div id="t2-results" class="results">
                            <button class="copy-btn" onclick="copyResults('t2-results')">üìã Copy</button>
                            <div class="stat-result"><span class="stat-label">Group 1: n, xÃÑ, s</span><span class="stat-value" id="t2-g1">-</span></div>
                            <div class="stat-result"><span class="stat-label">Group 2: n, xÃÑ, s</span><span class="stat-value" id="t2-g2">-</span></div>
                            <div class="stat-result"><span class="stat-label">Mean Difference</span><span class="stat-value" id="t2-diff">-</span></div>
                            <div class="stat-result"><span class="stat-label">t-statistic</span><span class="stat-value" id="t2-stat">-</span></div>
                            <div class="stat-result"><span class="stat-label">Degrees of Freedom</span><span class="stat-value" id="t2-df">-</span></div>
                            <div class="stat-result"><span class="stat-label">p-value</span><span class="stat-value" id="t2-pvalue">-</span></div>
                            <div class="stat-result"><span class="stat-label">Result (Œ± = 0.05)</span><span class="stat-value" id="t2-result">-</span></div>
                            <div class="stat-result"><span class="stat-label">Effect Size (Cohen's d)</span><span class="stat-value" id="t2-cohend">-</span></div>
                            <div class="stat-result"><span class="stat-label">95% CI for Difference</span><span class="stat-value" id="t2-ci">-</span></div>
                        </div>
                    </div>
                    
                    <!-- Paired t-Test -->
                    <div class="calc-section full-width">
                        <h3>üîó Paired t-Test</h3>
                        <div class="example-btns">
                            <span style="font-size:11px;color:var(--text-muted);align-self:center">Try:</span>
                            <button class="example-btn" onclick="loadExample('tp-before')">üíä Before/after treatment</button>
                            <button class="example-btn" onclick="loadExample('tp-nosig')">ü§∑ No change</button>
                        </div>
                        <p class="helper-text" style="margin-bottom:16px">Compare two related measurements (before/after, matched pairs). Enter paired data ‚Äî each line has two values separated by comma or tab.</p>
                        <div class="input-group">
                            <label for="tp-data">Paired data (value1, value2 per line):</label>
                            <textarea id="tp-data" style="height:120px" placeholder="Before, After&#10;85, 90&#10;78, 82&#10;92, 88&#10;70, 75&#10;65, 72"></textarea>
                        </div>
                        <div class="input-group">
                            <label for="tp-tail">Test Type:</label>
                            <select id="tp-tail">
                                <option value="two" selected>Two-tailed (Œº_d ‚â† 0)</option>
                                <option value="left">Left-tailed (Œº_d &lt; 0)</option>
                                <option value="right">Right-tailed (Œº_d &gt; 0)</option>
                            </select>
                        </div>
                        <div class="btn-row">
                            <button class="btn" onclick="calculatePairedT()">Run Paired t-Test</button>
                            <button class="formula-toggle" onclick="toggleFormula('tp-formula')">üìê Show formulas</button>
                        </div>
                        <div id="tp-formula" class="formula-box">
                            <div class="formula-title">Formulas Used (Paired t-test)</div>
                            Differences: d·µ¢ = x‚ÇÅ·µ¢ ‚àí x‚ÇÇ·µ¢<br>
                            Mean difference: dÃÑ = Œ£d·µ¢ / n<br>
                            SD of differences: s_d = ‚àö[Œ£(d·µ¢ ‚àí dÃÑ)¬≤ / (n‚àí1)]<br>
                            t = dÃÑ / (s_d / ‚àön), df = n ‚àí 1<br>
                            Cohen's d = |dÃÑ| / s_d
                        </div>
                        
                        <div id="tp-results" class="results">
                            <button class="copy-btn" onclick="copyResults('tp-results')">üìã Copy</button>
                            <div class="stat-result"><span class="stat-label">Number of Pairs (n)</span><span class="stat-value" id="tp-n">-</span></div>
                            <div class="stat-result"><span class="stat-label">Mean Difference (dÃÑ)</span><span class="stat-value" id="tp-meandiff">-</span></div>
                            <div class="stat-result"><span class="stat-label">SD of Differences (s_d)</span><span class="stat-value" id="tp-sddiff">-</span></div>
                            <div class="stat-result"><span class="stat-label">t-statistic</span><span class="stat-value" id="tp-stat">-</span></div>
                            <div class="stat-result"><span class="stat-label">Degrees of Freedom</span><span class="stat-value" id="tp-df">-</span></div>
                            <div class="stat-result"><span class="stat-label">p-value</span><span class="stat-value" id="tp-pvalue">-</span></div>
                            <div class="stat-result"><span class="stat-label">Result (Œ± = 0.05)</span><span class="stat-value" id="tp-result">-</span></div>
                            <div class="stat-result"><span class="stat-label">Effect Size (Cohen's d)</span><span class="stat-value" id="tp-cohend">-</span></div>
                            <div class="stat-result"><span class="stat-label">95% CI for Mean Difference</span><span class="stat-value" id="tp-ci">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB 3: Chi-Square -->
            <div id="tab-chisquare" class="tab-content" data-print-title="Chi-Square Tests">
                <div class="calculator-grid">
                    <!-- Chi-Square Test of Independence -->
                    <div class="calc-section">
                        <h3>üìä Test of Independence</h3>
                        <div class="example-btns">
                            <span style="font-size:11px;color:var(--text-muted);align-self:center">Try:</span>
                            <button class="example-btn" onclick="loadExample('chi-gender')">üë´ Gender √ó preference</button>
                            <button class="example-btn" onclick="loadExample('chi-treatment')">üíä Treatment √ó outcome</button>
                        </div>
                        <p class="helper-text" style="margin-bottom:16px">Enter a contingency table. Each row on a new line, values separated by commas. Rows = categories of variable 1, columns = categories of variable 2.</p>
                        <div class="input-group">
                            <label for="chi-data">Contingency table (observed frequencies):</label>
                            <textarea id="chi-data" style="height:100px" placeholder="30, 20, 50&#10;25, 35, 40"></textarea>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="chi-rowlabels">Row labels (optional, comma-separated):</label>
                                <input type="text" id="chi-rowlabels" placeholder="e.g., Male, Female">
                            </div>
                            <div class="input-group">
                                <label for="chi-collabels">Column labels (optional, comma-separated):</label>
                                <input type="text" id="chi-collabels" placeholder="e.g., A, B, C">
                            </div>
                        </div>
                        <div class="btn-row">
                            <button class="btn" onclick="calculateChiIndependence()">Run œá¬≤ Test</button>
                            <button class="formula-toggle" onclick="toggleFormula('chi-formula')">üìê Show formulas</button>
                        </div>
                        <div id="chi-formula" class="formula-box">
                            <div class="formula-title">Formulas Used</div>
                            Expected: E·µ¢‚±º = (Row Total √ó Col Total) / Grand Total<br>
                            œá¬≤ = Œ£ (O·µ¢‚±º ‚àí E·µ¢‚±º)¬≤ / E·µ¢‚±º<br>
                            df = (rows ‚àí 1)(cols ‚àí 1)<br>
                            Cram√©r's V = ‚àö(œá¬≤ / (n √ó min(rows‚àí1, cols‚àí1)))
                        </div>
                        
                        <div id="chi-results" class="results">
                            <button class="copy-btn" onclick="copyResults('chi-results')">üìã Copy</button>
                            <div class="stat-result"><span class="stat-label">Chi-Square Statistic (œá¬≤)</span><span class="stat-value" id="chi-stat">-</span></div>
                            <div class="stat-result"><span class="stat-label">Degrees of Freedom</span><span class="stat-value" id="chi-df">-</span></div>
                            <div class="stat-result"><span class="stat-label">p-value</span><span class="stat-value" id="chi-pvalue">-</span></div>
                            <div class="stat-result"><span class="stat-label">Result (Œ± = 0.05)</span><span class="stat-value" id="chi-result">-</span></div>
                            <div class="stat-result"><span class="stat-label">Effect Size (Cram√©r's V)</span><span class="stat-value" id="chi-cramers">-</span></div>
                        </div>
                        <div id="chi-tables" style="margin-top:16px"></div>
                    </div>
                    
                    <!-- Chi-Square Goodness of Fit -->
                    <div class="calc-section">
                        <h3>üéØ Goodness of Fit</h3>
                        <div class="example-btns">
                            <span style="font-size:11px;color:var(--text-muted);align-self:center">Try:</span>
                            <button class="example-btn" onclick="loadExample('gof-dice')">üé≤ Fair die test</button>
                            <button class="example-btn" onclick="loadExample('gof-genetics')">üß¨ Mendelian ratio</button>
                        </div>
                        <p class="helper-text" style="margin-bottom:16px">Compare observed frequencies against expected frequencies (or a uniform distribution).</p>
                        <div class="input-group">
                            <label for="gof-observed">Observed frequencies (comma-separated):</label>
                            <input type="text" id="gof-observed" placeholder="e.g., 18, 22, 16, 24, 10, 20">
                        </div>
                        <div class="input-group">
                            <label for="gof-expected">Expected frequencies or proportions (leave blank for uniform):</label>
                            <input type="text" id="gof-expected" placeholder="e.g., 18.33, 18.33, ... or 1/6, 1/6, ...">
                            <p class="helper-text">Enter expected counts, or leave blank to assume equal frequencies across categories.</p>
                        </div>
                        <div class="input-group">
                            <label for="gof-labels">Category labels (optional, comma-separated):</label>
                            <input type="text" id="gof-labels" placeholder="e.g., 1, 2, 3, 4, 5, 6">
                        </div>
                        <div class="btn-row">
                            <button class="btn" onclick="calculateGoodnessOfFit()">Run œá¬≤ Test</button>
                            <button class="formula-toggle" onclick="toggleFormula('gof-formula')">üìê Show formulas</button>
                        </div>
                        <div id="gof-formula" class="formula-box">
                            <div class="formula-title">Formulas Used</div>
                            œá¬≤ = Œ£ (O·µ¢ ‚àí E·µ¢)¬≤ / E·µ¢<br>
                            df = k ‚àí 1 (k = number of categories)<br>
                            p-value from œá¬≤ distribution
                        </div>
                        
                        <div id="gof-results" class="results">
                            <button class="copy-btn" onclick="copyResults('gof-results')">üìã Copy</button>
                            <div class="stat-result"><span class="stat-label">Number of Categories (k)</span><span class="stat-value" id="gof-k">-</span></div>
                            <div class="stat-result"><span class="stat-label">Chi-Square Statistic (œá¬≤)</span><span class="stat-value" id="gof-stat">-</span></div>
                            <div class="stat-result"><span class="stat-label">Degrees of Freedom</span><span class="stat-value" id="gof-df">-</span></div>
                            <div class="stat-result"><span class="stat-label">p-value</span><span class="stat-value" id="gof-pvalue">-</span></div>
                            <div class="stat-result"><span class="stat-label">Result (Œ± = 0.05)</span><span class="stat-value" id="gof-result">-</span></div>
                        </div>
                        <div id="gof-table" style="margin-top:16px"></div>
                        
                        <div class="visualization">
                            <canvas id="gof-chart" class="chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB: ANOVA -->
            <div id="tab-anova" class="tab-content" data-print-title="One-Way ANOVA">
                <div class="calculator-grid single">
                    <div class="calc-section">
                        <h3>üî¨ One-Way ANOVA</h3>
                        <div class="example-btns">
                            <span style="font-size:11px;color:var(--text-muted);align-self:center">Try:</span>
                            <button class="example-btn" onclick="loadExample('anova-plant')">üå± Plant growth</button>
                            <button class="example-btn" onclick="loadExample('anova-scores')">üìù Test scores</button>
                            <button class="example-btn" onclick="loadExample('anova-nosig')">üîÄ No difference</button>
                        </div>
                        <p class="helper-text" style="margin-bottom:16px">Enter group data. Each line: <code>GroupName: value1, value2, ...</code><br>At least 2 groups required.</p>
                        <div class="input-group">
                            <label for="anova-data">Group Data:</label>
                            <textarea id="anova-data" style="height:140px" placeholder="Control: 4.2, 3.8, 4.1, 3.9, 4.0&#10;Treatment A: 5.1, 5.3, 4.9, 5.0, 5.2&#10;Treatment B: 6.0, 5.8, 6.2, 5.9, 6.1"></textarea>
                        </div>
                        <div class="btn-row">
                            <button class="btn" onclick="calculateANOVA()">Run ANOVA</button>
                            <button class="formula-toggle" onclick="toggleFormula('anova-formula')">üìê Show formulas</button>
                        </div>
                        <div id="anova-formula" class="formula-box">
                            <div class="formula-title">Formulas Used</div>
                            SS<sub>between</sub> = Œ£ n‚±º(xÃÑ‚±º ‚àí xÃÑ)¬≤ ‚Äî variation between group means<br>
                            SS<sub>within</sub> = Œ£Œ£ (x·µ¢‚±º ‚àí xÃÑ‚±º)¬≤ ‚Äî variation within groups<br>
                            MS = SS / df,  F = MS<sub>between</sub> / MS<sub>within</sub><br>
                            Œ∑¬≤ = SS<sub>between</sub> / SS<sub>total</sub> (effect size)<br>
                            Post-hoc: Bonferroni-corrected pairwise t-tests (Œ± / number of comparisons)
                        </div>

                        <div id="anova-results" class="results">
                            <button class="copy-btn" onclick="copyResults('anova-results')">üìã Copy</button>
                            <div class="stat-result"><span class="stat-label">Number of Groups (k)</span><span class="stat-value" id="anova-k">-</span></div>
                            <div class="stat-result"><span class="stat-label">Total N</span><span class="stat-value" id="anova-n">-</span></div>
                            <div class="stat-result"><span class="stat-label">F-Statistic</span><span class="stat-value" id="anova-f">-</span></div>
                            <div class="stat-result"><span class="stat-label">p-value</span><span class="stat-value" id="anova-p">-</span></div>
                            <div class="stat-result"><span class="stat-label">Effect Size (Œ∑¬≤)</span><span class="stat-value" id="anova-eta2">-</span></div>
                            <div class="stat-result"><span class="stat-label">Conclusion</span><span class="stat-value" id="anova-conclusion">-</span></div>
                        </div>

                        <div id="anova-table-container" style="display:none; margin-top:16px;"></div>
                        <div id="anova-groups-container" style="display:none; margin-top:16px;"></div>
                        <div id="anova-posthoc-container" style="display:none; margin-top:16px;"></div>

                        <div class="visualization">
                            <canvas id="boxplot" class="chart" style="height:350px"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Regression -->
            <div id="tab-regression" class="tab-content" data-print-title="Linear Regression & Correlation">
                <div class="calculator-grid single">
                    <div class="calc-section">
                        <h3>üìà Linear Regression & Correlation</h3>
                        <div class="example-btns">
                            <span style="font-size:11px;color:var(--text-muted);align-self:center">Try:</span>
                            <button class="example-btn" onclick="loadExample('reg-study')">üìö Study hours vs score</button>
                            <button class="example-btn" onclick="loadExample('reg-weak')">üîÄ Weak correlation</button>
                        </div>
                        <p class="helper-text" style="margin-bottom:16px">Enter paired (x, y) data. One pair per line, separated by comma or tab.</p>
                        <div class="input-group">
                            <label for="reg-data">Data (x, y pairs):</label>
                            <textarea id="reg-data" style="height:140px" placeholder="1, 2.1&#10;2, 3.9&#10;3, 6.2&#10;4, 7.8&#10;5, 10.1"></textarea>
                        </div>
                        <div class="btn-row">
                            <button class="btn" onclick="calculateRegression()">Fit Regression</button>
                            <button class="formula-toggle" onclick="toggleFormula('reg-formula')">üìê Show formulas</button>
                        </div>
                        <div id="reg-formula" class="formula-box">
                            <div class="formula-title">Formulas Used</div>
                            Slope: b‚ÇÅ = Œ£(x·µ¢‚àíxÃÑ)(y·µ¢‚àí»≥) / Œ£(x·µ¢‚àíxÃÑ)¬≤<br>
                            Intercept: b‚ÇÄ = »≥ ‚àí b‚ÇÅxÃÑ<br>
                            Correlation: r = Œ£(x·µ¢‚àíxÃÑ)(y·µ¢‚àí»≥) / ‚àö[Œ£(x·µ¢‚àíxÃÑ)¬≤ ¬∑ Œ£(y·µ¢‚àí»≥)¬≤]<br>
                            R¬≤ = r¬≤ (proportion of variance explained)<br>
                            S‚Çë = ‚àö[Œ£(y·µ¢‚àí≈∑·µ¢)¬≤ / (n‚àí2)]
                        </div>
                        
                        <div id="reg-results" class="results">
                            <button class="copy-btn" onclick="copyResults('reg-results')">üìã Copy</button>
                            <div class="stat-result"><span class="stat-label">Sample Size (n)</span><span class="stat-value" id="reg-n">-</span></div>
                            <div class="stat-result"><span class="stat-label">Correlation (r)</span><span class="stat-value" id="reg-r">-</span></div>
                            <div class="stat-result"><span class="stat-label">R¬≤ (coefficient of determination)</span><span class="stat-value" id="reg-r2">-</span></div>
                            <div class="stat-result"><span class="stat-label">Regression Equation</span><span class="stat-value" id="reg-eq">-</span></div>
                            <div class="stat-result"><span class="stat-label">Slope (b‚ÇÅ)</span><span class="stat-value" id="reg-slope">-</span></div>
                            <div class="stat-result"><span class="stat-label">Intercept (b‚ÇÄ)</span><span class="stat-value" id="reg-intercept">-</span></div>
                            <div class="stat-result"><span class="stat-label">Std Error of Estimate (S‚Çë)</span><span class="stat-value" id="reg-se">-</span></div>
                            <div class="stat-result"><span class="stat-label">Slope t-test (H‚ÇÄ: Œ≤‚ÇÅ=0)</span><span class="stat-value" id="reg-ttest">-</span></div>
                        </div>
                        
                        <div class="visualization">
                            <canvas id="scatterplot" class="chart" style="height:350px"></canvas>
                        </div>

                        <div class="visualization" id="residual-plot-container" style="display:none">
                            <canvas id="residualplot" class="chart" style="height:250px"></canvas>
                        </div>

                        <div id="reg-predict-section" style="display:none; margin-top:16px; padding:16px; background:var(--section-bg); border-radius:8px; border:1px solid var(--section-border);">
                            <h4 style="margin-bottom:8px; color:var(--text-primary); font-size:14px;">üîÆ Prediction</h4>
                            <div style="display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap;">
                                <div class="input-group" style="flex:1; min-width:120px;">
                                    <label for="reg-predict-x">Predict y for x =</label>
                                    <input type="number" id="reg-predict-x" step="any" placeholder="Enter x value">
                                </div>
                                <button class="btn" onclick="predictY()" style="height:42px;">Predict</button>
                            </div>
                            <div id="reg-predict-result" style="margin-top:12px; display:none;">
                                <div class="stat-result"><span class="stat-label">Predicted ≈∑</span><span class="stat-value" id="reg-pred-y">-</span></div>
                                <div class="stat-result"><span class="stat-label">95% Confidence Interval (mean)</span><span class="stat-value" id="reg-pred-ci">-</span></div>
                                <div class="stat-result"><span class="stat-label">95% Prediction Interval (individual)</span><span class="stat-value" id="reg-pred-pi">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB: Power & Sample Size -->
            <div id="tab-power" class="tab-content" data-print-title="Power Analysis & Sample Size">
                <div class="calculator-grid single">
                    <div class="calc-section">
                        <h3>üìê Sample Size & Power</h3>
                        <div class="example-btns">
                            <span style="font-size:11px;color:var(--text-muted);align-self:center">Try:</span>
                            <button class="example-btn" onclick="loadExample('ss-small')">üî¨ Detect small effect</button>
                            <button class="example-btn" onclick="loadExample('ss-large')">üì¢ Detect large effect</button>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="ss-effect">Effect Size (Cohen's d):</label>
                                <input type="number" id="ss-effect" step="any" placeholder="e.g., 0.5" value="0.5">
                                <p class="helper-text">Small: 0.2 ¬∑ Medium: 0.5 ¬∑ Large: 0.8</p>
                            </div>
                            <div class="input-group">
                                <label for="ss-power">Statistical Power:</label>
                                <select id="ss-power">
                                    <option value="0.7">70%</option>
                                    <option value="0.8" selected>80%</option>
                                    <option value="0.9">90%</option>
                                    <option value="0.95">95%</option>
                                </select>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="ss-alpha">Significance Level (Œ±):</label>
                            <select id="ss-alpha">
                                <option value="0.01">0.01</option>
                                <option value="0.05" selected>0.05</option>
                                <option value="0.1">0.10</option>
                            </select>
                        </div>
                        <div class="btn-row">
                        <button class="btn" onclick="calculateSampleSize()">Calculate Sample Size</button>
                        <button class="formula-toggle" onclick="toggleFormula('ss-formula')">üìê Show formulas</button>
                        </div>
                        <div id="ss-formula" class="formula-box">
                            <div class="formula-title">Formulas Used</div>
                            n = ‚åà((z<sub>Œ±/2</sub> + z<sub>Œ≤</sub>) / d)¬≤‚åâ<br>
                            where z<sub>Œ±/2</sub> = inverse normal CDF at 1‚àíŒ±/2<br>
                            z<sub>Œ≤</sub> = inverse normal CDF at power<br>
                            d = Cohen's d (effect size in std dev units)
                        </div>
                        
                        <div id="samplesize-results" class="results">
                            <button class="copy-btn" onclick="copyResults('samplesize-results')">üìã Copy</button>
                            <div class="stat-result"><span class="stat-label">Required Sample Size (n)</span><span class="stat-value" id="ss-n">-</span></div>
                            <div class="stat-result"><span class="stat-label">Effect Size Interpretation</span><span class="stat-value" id="ss-interpretation">-</span></div>
                            <div class="stat-result"><span class="stat-label">Minimum Detectable Difference</span><span class="stat-value" id="ss-mdd">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            Built by <a href="https://onyxclaw.substack.com" target="_blank">Onyx</a> ¬∑ Toggle ‚òÄÔ∏è/üåô for light/dark mode ¬∑ Print-friendly üñ®Ô∏è
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Theme ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function initTheme() {
            const saved = localStorage.getItem('statcalc-theme');
            if (saved) {
                applyTheme(saved);
            } else {
                // Respect system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
            }
        }
        
        // Listen for system theme changes (only when no manual override)
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('statcalc-theme')) {
                applyTheme(e.matches ? 'dark' : 'light');
                redrawCharts();
            }
        });
        
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            applyTheme(next);
            localStorage.setItem('statcalc-theme', next);
            redrawCharts();
        }
        
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('toggle-icon').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('theme-label').textContent = theme + ' mode';
        }
        
        initTheme();
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Formula Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function toggleFormula(id) {
            const el = document.getElementById(id);
            el.classList.toggle('visible');
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Example Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function loadExample(key) {
            const examples = {
                // Descriptive
                'desc-exam': { target: 'data-input', data: '72, 85, 91, 68, 77, 83, 95, 62, 88, 79, 74, 90, 81, 67, 86, 73, 92, 78, 84, 70', action: 'calculateDescriptive' },
                'desc-heights': { target: 'data-input', data: '165.2, 170.1, 158.7, 175.3, 162.8, 180.5, 168.4, 172.9, 155.6, 177.2, 163.1, 169.8, 174.7, 160.3, 167.5', action: 'calculateDescriptive' },
                'desc-skewed': { target: 'data-input', data: '1.2, 1.5, 1.8, 2.0, 2.1, 2.3, 2.5, 2.8, 3.1, 3.5, 4.2, 5.1, 6.8, 9.2, 15.7', action: 'calculateDescriptive' },
                // CI
                'ci-textbook': { fields: {'ci-mean': '98.2', 'ci-std': '0.73', 'ci-n': '36', 'ci-level': '95'}, action: 'calculateCI' },
                'ci-small': { fields: {'ci-mean': '52.3', 'ci-std': '8.1', 'ci-n': '8', 'ci-level': '95'}, action: 'calculateCI' },
                // One-sample t
                't1-sig': { fields: {'t-mean': '105.3', 't-std': '12.5', 't-n': '25', 't-null': '100', 't-tail': 'two'}, action: 'calculateTTest' },
                't1-nonsig': { fields: {'t-mean': '101.2', 't-std': '15.8', 't-n': '20', 't-null': '100', 't-tail': 'two'}, action: 'calculateTTest' },
                // Two-sample t
                't2-drug': { targets: {'t2-data1': '8.2, 7.1, 9.3, 6.8, 8.5, 7.9, 9.1, 8.0, 7.5, 8.8', 't2-data2': '5.1, 6.3, 4.8, 5.7, 6.0, 5.5, 4.9, 5.2, 6.1, 5.8'}, fields: {'t2-tail': 'two'}, action: 'calculateTwoSampleT' },
                't2-equal': { targets: {'t2-data1': '23.1, 25.4, 22.8, 24.6, 23.9, 24.2, 23.5', 't2-data2': '24.0, 23.7, 24.8, 23.3, 24.1, 23.6, 24.5'}, fields: {'t2-tail': 'two'}, action: 'calculateTwoSampleT' },
                // Regression
                'reg-study': { target: 'reg-data', data: '1, 52\n2, 58\n3, 65\n4, 71\n5, 78\n6, 82\n7, 88\n8, 91\n9, 95\n10, 97', action: 'calculateRegression' },
                'reg-weak': { target: 'reg-data', data: '1, 45\n2, 62\n3, 38\n4, 55\n5, 70\n6, 42\n7, 68\n8, 51\n9, 59\n10, 48', action: 'calculateRegression' },
                // Sample size
                'ss-small': { fields: {'ss-effect': '0.2', 'ss-power': '0.8', 'ss-alpha': '0.05'}, action: 'calculateSampleSize' },
                'ss-large': { fields: {'ss-effect': '0.8', 'ss-power': '0.9', 'ss-alpha': '0.05'}, action: 'calculateSampleSize' },
                // Paired t-test
                'tp-before': { target: 'tp-data', data: '85, 90\n78, 82\n92, 88\n70, 75\n65, 72\n88, 95\n76, 80\n82, 86\n90, 91\n74, 79', fields: {'tp-tail': 'two'}, action: 'calculatePairedT' },
                'tp-nosig': { target: 'tp-data', data: '82, 84\n75, 73\n90, 91\n68, 67\n85, 86\n79, 78\n88, 89\n72, 71', fields: {'tp-tail': 'two'}, action: 'calculatePairedT' },
                // Chi-square independence
                'chi-gender': { target: 'chi-data', data: '30, 20, 50\n25, 35, 40', fields: {'chi-rowlabels': 'Male, Female', 'chi-collabels': 'Comedy, Drama, Action'}, action: 'calculateChiIndependence' },
                'chi-treatment': { target: 'chi-data', data: '45, 15\n30, 30\n35, 25', fields: {'chi-rowlabels': 'Drug A, Drug B, Placebo', 'chi-collabels': 'Improved, No change'}, action: 'calculateChiIndependence' },
                // Goodness of fit
                'gof-dice': { fields: {'gof-observed': '18, 22, 16, 24, 10, 20', 'gof-expected': '', 'gof-labels': '‚öÄ, ‚öÅ, ‚öÇ, ‚öÉ, ‚öÑ, ‚öÖ'}, action: 'calculateGoodnessOfFit' },
                'gof-genetics': { fields: {'gof-observed': '315, 108, 101, 32', 'gof-expected': '312.75, 104.25, 104.25, 34.75', 'gof-labels': 'Round Yellow, Round Green, Wrinkled Yellow, Wrinkled Green'}, action: 'calculateGoodnessOfFit' },
                // ANOVA
                'anova-plant': { target: 'anova-data', data: 'Control: 4.81, 4.17, 4.41, 3.59, 5.87, 3.83, 6.03, 4.89, 4.32, 4.69\nLow Dose: 4.50, 5.87, 5.68, 6.22, 6.66, 4.56, 5.12, 5.78, 5.34, 5.92\nHigh Dose: 6.31, 5.12, 5.54, 5.50, 5.37, 5.29, 4.92, 6.15, 5.80, 5.26', action: 'calculateANOVA' },
                'anova-scores': { target: 'anova-data', data: 'Lecture: 72, 68, 75, 71, 65, 74, 69, 73\nOnline: 78, 82, 80, 85, 76, 81, 79, 83\nHybrid: 85, 88, 82, 90, 84, 87, 86, 89', action: 'calculateANOVA' },
                'anova-nosig': { target: 'anova-data', data: 'Group A: 50, 55, 48, 52, 51, 49, 53\nGroup B: 51, 49, 54, 50, 52, 48, 53\nGroup C: 49, 52, 50, 53, 48, 51, 50', action: 'calculateANOVA' },
            };
            
            const ex = examples[key];
            if (!ex) return;
            
            // Fill single textarea
            if (ex.target) {
                document.getElementById(ex.target).value = ex.data;
            }
            // Fill multiple textareas
            if (ex.targets) {
                for (const [id, val] of Object.entries(ex.targets)) {
                    document.getElementById(id).value = val;
                }
            }
            // Fill input fields / selects
            if (ex.fields) {
                for (const [id, val] of Object.entries(ex.fields)) {
                    document.getElementById(id).value = val;
                }
            }
            // Auto-calculate
            if (ex.action && window[ex.action]) {
                window[ex.action]();
            }
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function switchTab(name) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + name).classList.add('active');
            if (typeof event !== 'undefined' && event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                document.querySelectorAll('.tab-btn').forEach(b => {
                    if (b.getAttribute('onclick') === "switchTab('" + name + "')") b.classList.add('active');
                });
            }
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Copy Results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function copyResults(containerId) {
            const container = document.getElementById(containerId);
            const rows = container.querySelectorAll('.stat-result');
            const text = Array.from(rows).map(row => {
                const label = row.querySelector('.stat-label').textContent;
                const value = row.querySelector('.stat-value').textContent;
                return `${label}: ${value}`;
            }).join('\n');
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = container.querySelector('.copy-btn');
                btn.textContent = '‚úì Copied';
                btn.classList.add('copied');
                setTimeout(() => { btn.textContent = 'üìã Copy'; btn.classList.remove('copied'); }, 2000);
            });
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Statistical Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function mean(arr) { return arr.reduce((a, b) => a + b, 0) / arr.length; }
        
        function median(arr) {
            const s = [...arr].sort((a, b) => a - b);
            const mid = Math.floor(s.length / 2);
            return s.length % 2 === 0 ? (s[mid - 1] + s[mid]) / 2 : s[mid];
        }
        
        function quartile(arr, q) {
            const s = [...arr].sort((a, b) => a - b);
            const pos = (s.length - 1) * q;
            const base = Math.floor(pos);
            const rest = pos - base;
            return s[base + 1] !== undefined ? s[base] + rest * (s[base + 1] - s[base]) : s[base];
        }
        
        function variance(arr) {
            const m = mean(arr);
            return arr.reduce((a, b) => a + (b - m) ** 2, 0) / (arr.length - 1);
        }
        
        function standardDeviation(arr) { return Math.sqrt(variance(arr)); }
        
        function skewness(arr) {
            const n = arr.length;
            if (n < 3) return NaN;
            const m = mean(arr), s = standardDeviation(arr);
            const sum = arr.reduce((a, x) => a + ((x - m) / s) ** 3, 0);
            return (n / ((n - 1) * (n - 2))) * sum;
        }
        
        function parseData(input) {
            return input.replace(/\n/g, ',').split(',').map(x => parseFloat(x.trim())).filter(x => !isNaN(x));
        }
        
        function parsePairs(input) {
            return input.trim().split('\n').map(line => {
                const parts = line.split(/[,\t]+/).map(x => parseFloat(x.trim()));
                return parts.length >= 2 && !isNaN(parts[0]) && !isNaN(parts[1]) ? [parts[0], parts[1]] : null;
            }).filter(Boolean);
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ t-distribution ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function lnGamma(z) {
            const c = [0.99999999999980993, 676.5203681218851, -1259.1392167224028,
                771.32342877765313, -176.61502916214059, 12.507343278686905,
                -0.13857109526572012, 9.9843695780195716e-6, 1.5056327351493116e-7];
            if (z < 0.5) return Math.log(Math.PI / Math.sin(Math.PI * z)) - lnGamma(1 - z);
            z -= 1;
            let x = c[0];
            for (let i = 1; i < 9; i++) x += c[i] / (z + i);
            const t = z + 7.5;
            return 0.5 * Math.log(2 * Math.PI) + (z + 0.5) * Math.log(t) - t + Math.log(x);
        }
        
        function betaIncomplete(a, b, x) {
            if (x === 0 || x === 1) return x;
            if (x > (a + 1) / (a + b + 2)) return 1 - betaIncomplete(b, a, 1 - x);
            const lnBeta = lnGamma(a) + lnGamma(b) - lnGamma(a + b);
            const front = Math.exp(Math.log(x) * a + Math.log(1 - x) * b - lnBeta) / a;
            let f = 1, c = 1, d = 1 - (a + b) * x / (a + 1);
            if (Math.abs(d) < 1e-30) d = 1e-30;
            d = 1 / d; f = d;
            for (let m = 1; m <= 200; m++) {
                let num = m * (b - m) * x / ((a + 2*m - 1) * (a + 2*m));
                d = 1 + num * d; if (Math.abs(d) < 1e-30) d = 1e-30;
                c = 1 + num / c; if (Math.abs(c) < 1e-30) c = 1e-30;
                d = 1 / d; f *= c * d;
                num = -(a + m) * (a + b + m) * x / ((a + 2*m) * (a + 2*m + 1));
                d = 1 + num * d; if (Math.abs(d) < 1e-30) d = 1e-30;
                c = 1 + num / c; if (Math.abs(c) < 1e-30) c = 1e-30;
                d = 1 / d;
                const delta = c * d; f *= delta;
                if (Math.abs(delta - 1) < 1e-10) break;
            }
            return front * f;
        }
        
        function tCDF(t, df) {
            const x = df / (df + t * t);
            const p = 0.5 * betaIncomplete(df / 2, 0.5, x);
            return t >= 0 ? 1 - p : p;
        }
        
        function tPValue(t, df, tail) {
            if (tail === 'two') return 2 * (1 - tCDF(Math.abs(t), df));
            if (tail === 'left') return tCDF(t, df);
            return 1 - tCDF(t, df);
        }
        
        function tCritical(df, alpha) {
            const target = 1 - alpha / 2;
            let t = 1.96;
            for (let i = 0; i < 50; i++) {
                const p = tCDF(t, df);
                const err = p - target;
                if (Math.abs(err) < 1e-10) break;
                const dp = (tCDF(t + 0.0001, df) - tCDF(t - 0.0001, df)) / 0.0002;
                if (Math.abs(dp) < 1e-15) break;
                t -= err / dp;
            }
            return t;
        }
        
        function erf(x) {
            const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
            const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
            const sign = x >= 0 ? 1 : -1;
            x = Math.abs(x);
            const t = 1 / (1 + p * x);
            return sign * (1 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t * Math.exp(-x*x));
        }
        
        function normalCDF(z) { return 0.5 * (1 + erf(z / Math.sqrt(2))); }
        
        function normalInvCDF(p) {
            if (p <= 0) return -Infinity;
            if (p >= 1) return Infinity;
            if (p === 0.5) return 0;
            const a = [-3.969683028665376e+01, 2.209460984245205e+02, -2.759285104469687e+02, 1.383577518672690e+02, -3.066479806614716e+01, 2.506628277459239e+00];
            const b = [-5.447609879822406e+01, 1.615858368580409e+02, -1.556989798598866e+02, 6.680131188771972e+01, -1.328068155288572e+01];
            const c = [-7.784894002430293e-03, -3.223964580411365e-01, -2.400758277161838e+00, -2.549732539343734e+00, 4.374664141464968e+00, 2.938163982698783e+00];
            const d = [7.784695709041462e-03, 3.224671290700398e-01, 2.445134137142996e+00, 3.754408661907416e+00];
            const pLow = 0.02425, pHigh = 1 - pLow;
            let q, r;
            if (p < pLow) {
                q = Math.sqrt(-2 * Math.log(p));
                return (((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5]) / ((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
            } else if (p <= pHigh) {
                q = p - 0.5; r = q * q;
                return (((((a[0]*r+a[1])*r+a[2])*r+a[3])*r+a[4])*r+a[5])*q / (((((b[0]*r+b[1])*r+b[2])*r+b[3])*r+b[4])*r+1);
            } else {
                q = Math.sqrt(-2 * Math.log(1 - p));
                return -(((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5]) / ((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
            }
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Saved state for cross-module linking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let lastDescriptiveData = null;
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Calculator Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        function calculateDescriptive() {
            const input = document.getElementById('data-input').value;
            const data = parseData(input);
            if (data.length === 0) { alert('Please enter valid numeric data'); return; }
            
            lastDescriptiveData = data;
            const q1 = quartile(data, 0.25), q3 = quartile(data, 0.75);
            const sk = skewness(data);
            
            document.getElementById('desc-n').textContent = data.length;
            document.getElementById('desc-mean').textContent = mean(data).toFixed(4);
            document.getElementById('desc-median').textContent = median(data).toFixed(4);
            document.getElementById('desc-std').textContent = standardDeviation(data).toFixed(4);
            document.getElementById('desc-var').textContent = variance(data).toFixed(4);
            document.getElementById('desc-range').textContent = `${Math.min(...data).toFixed(4)} / ${Math.max(...data).toFixed(4)}`;
            document.getElementById('desc-iqr').textContent = `${q1.toFixed(4)} ‚Äì ${q3.toFixed(4)}  (IQR = ${(q3 - q1).toFixed(4)})`;
            document.getElementById('desc-skew').textContent = isNaN(sk) ? 'n < 3' : sk.toFixed(4);
            
            document.getElementById('descriptive-results').classList.add('active');
            drawHistogram(data);
        }
        
        function fillCIFromDescriptive() {
            if (!lastDescriptiveData || lastDescriptiveData.length < 2) {
                alert('Run descriptive stats first');
                return;
            }
            document.getElementById('ci-mean').value = mean(lastDescriptiveData).toFixed(4);
            document.getElementById('ci-std').value = standardDeviation(lastDescriptiveData).toFixed(4);
            document.getElementById('ci-n').value = lastDescriptiveData.length;
        }
        
        function calculateCI() {
            const m = parseFloat(document.getElementById('ci-mean').value);
            const s = parseFloat(document.getElementById('ci-std').value);
            const n = parseInt(document.getElementById('ci-n').value);
            const level = parseInt(document.getElementById('ci-level').value);
            if (isNaN(m) || isNaN(s) || isNaN(n) || n < 2) { alert('Please enter valid numbers (n ‚â• 2)'); return; }
            
            const alpha = (100 - level) / 100;
            const df = n - 1;
            const t = tCritical(df, alpha);
            const se = s / Math.sqrt(n);
            const margin = t * se;
            
            document.getElementById('ci-se').textContent = se.toFixed(4);
            document.getElementById('ci-tcrit').textContent = `t(${df}) = ${t.toFixed(4)}`;
            document.getElementById('ci-margin').textContent = `¬± ${margin.toFixed(4)}`;
            document.getElementById('ci-lower').textContent = (m - margin).toFixed(4);
            document.getElementById('ci-upper').textContent = (m + margin).toFixed(4);
            document.getElementById('ci-interval').textContent = `[${(m - margin).toFixed(4)}, ${(m + margin).toFixed(4)}]`;
            document.getElementById('ci-results').classList.add('active');
        }
        
        function calculateTTest() {
            const sampleMean = parseFloat(document.getElementById('t-mean').value);
            const s = parseFloat(document.getElementById('t-std').value);
            const n = parseInt(document.getElementById('t-n').value);
            const nullMean = parseFloat(document.getElementById('t-null').value);
            const tail = document.getElementById('t-tail').value;
            if (isNaN(sampleMean) || isNaN(s) || isNaN(n) || isNaN(nullMean) || n < 2) { alert('Please enter valid numbers (n ‚â• 2)'); return; }
            
            const se = s / Math.sqrt(n);
            const t = (sampleMean - nullMean) / se;
            const df = n - 1;
            const pValue = tPValue(t, df, tail);
            const cohensD = Math.abs(sampleMean - nullMean) / s;
            const tailLabel = tail === 'two' ? 'two-tailed' : (tail === 'left' ? 'left-tailed' : 'right-tailed');
            
            document.getElementById('t-stat').textContent = t.toFixed(4);
            document.getElementById('t-df').textContent = df;
            document.getElementById('t-pvalue').textContent = `${pValue < 0.0001 ? pValue.toExponential(2) : pValue.toFixed(4)} (${tailLabel})`;
            document.getElementById('t-result').textContent = pValue < 0.05 ? 'Reject H‚ÇÄ ‚úì' : 'Fail to reject H‚ÇÄ';
            document.getElementById('t-cohend').textContent = `${cohensD.toFixed(4)} (${cohensD < 0.2 ? 'negligible' : cohensD < 0.5 ? 'small' : cohensD < 0.8 ? 'medium' : 'large'})`;
            document.getElementById('ttest-results').classList.add('active');
        }
        
        function calculateTwoSampleT() {
            const d1 = parseData(document.getElementById('t2-data1').value);
            const d2 = parseData(document.getElementById('t2-data2').value);
            const tail = document.getElementById('t2-tail').value;
            if (d1.length < 2 || d2.length < 2) { alert('Each group needs at least 2 values'); return; }
            
            const m1 = mean(d1), m2 = mean(d2);
            const s1 = standardDeviation(d1), s2 = standardDeviation(d2);
            const n1 = d1.length, n2 = d2.length;
            const v1 = variance(d1), v2 = variance(d2);
            
            // Welch's t-test
            const se = Math.sqrt(v1/n1 + v2/n2);
            const t = (m1 - m2) / se;
            
            // Welch‚ÄìSatterthwaite degrees of freedom
            const dfNum = (v1/n1 + v2/n2) ** 2;
            const dfDen = (v1/n1)**2/(n1-1) + (v2/n2)**2/(n2-1);
            const df = dfNum / dfDen;
            
            const pValue = tPValue(t, df, tail);
            
            // Pooled SD for Cohen's d
            const pooledSD = Math.sqrt(((n1-1)*v1 + (n2-1)*v2) / (n1+n2-2));
            const cohensD = Math.abs(m1 - m2) / pooledSD;
            
            // 95% CI for mean difference
            const tCrit = tCritical(df, 0.05);
            const margin = tCrit * se;
            
            const tailLabel = tail === 'two' ? 'two-tailed' : (tail === 'left' ? 'left-tailed' : 'right-tailed');
            
            document.getElementById('t2-g1').textContent = `n=${n1}, xÃÑ=${m1.toFixed(4)}, s=${s1.toFixed(4)}`;
            document.getElementById('t2-g2').textContent = `n=${n2}, xÃÑ=${m2.toFixed(4)}, s=${s2.toFixed(4)}`;
            document.getElementById('t2-diff').textContent = (m1 - m2).toFixed(4);
            document.getElementById('t2-stat').textContent = t.toFixed(4);
            document.getElementById('t2-df').textContent = df.toFixed(2);
            document.getElementById('t2-pvalue').textContent = `${pValue < 0.0001 ? pValue.toExponential(2) : pValue.toFixed(4)} (${tailLabel})`;
            document.getElementById('t2-result').textContent = pValue < 0.05 ? 'Reject H‚ÇÄ ‚úì' : 'Fail to reject H‚ÇÄ';
            document.getElementById('t2-cohend').textContent = `${cohensD.toFixed(4)} (${cohensD < 0.2 ? 'negligible' : cohensD < 0.5 ? 'small' : cohensD < 0.8 ? 'medium' : 'large'})`;
            document.getElementById('t2-ci').textContent = `[${(m1-m2-margin).toFixed(4)}, ${(m1-m2+margin).toFixed(4)}]`;
            document.getElementById('t2-results').classList.add('active');
        }
        
        function calculateRegression() {
            const pairs = parsePairs(document.getElementById('reg-data').value);
            if (pairs.length < 3) { alert('Need at least 3 data pairs'); return; }
            
            const xs = pairs.map(p => p[0]), ys = pairs.map(p => p[1]);
            const n = pairs.length;
            const mx = mean(xs), my = mean(ys);
            
            // Sums for regression
            let ssxx = 0, ssyy = 0, ssxy = 0;
            for (let i = 0; i < n; i++) {
                ssxx += (xs[i] - mx) ** 2;
                ssyy += (ys[i] - my) ** 2;
                ssxy += (xs[i] - mx) * (ys[i] - my);
            }
            
            const slope = ssxy / ssxx;
            const intercept = my - slope * mx;
            const r = ssxy / Math.sqrt(ssxx * ssyy);
            const r2 = r * r;
            
            // Standard error of estimate
            let ssr = 0;
            for (let i = 0; i < n; i++) {
                const predicted = intercept + slope * xs[i];
                ssr += (ys[i] - predicted) ** 2;
            }
            const se = Math.sqrt(ssr / (n - 2));
            
            // t-test for slope significance
            const slopeStdErr = se / Math.sqrt(ssxx);
            const tStat = slope / slopeStdErr;
            const df = n - 2;
            const pSlope = tPValue(tStat, df, 'two');
            
            const sign = intercept >= 0 ? '+' : '‚àí';
            const absInt = Math.abs(intercept).toFixed(4);
            
            document.getElementById('reg-n').textContent = n;
            document.getElementById('reg-r').textContent = `${r.toFixed(4)} (${Math.abs(r) < 0.3 ? 'weak' : Math.abs(r) < 0.7 ? 'moderate' : 'strong'})`;
            document.getElementById('reg-r2').textContent = `${r2.toFixed(4)} (${(r2 * 100).toFixed(1)}% variance explained)`;
            document.getElementById('reg-eq').textContent = `≈∑ = ${slope.toFixed(4)}x ${sign} ${absInt}`;
            document.getElementById('reg-slope').textContent = `${slope.toFixed(4)} (SE = ${slopeStdErr.toFixed(4)})`;
            document.getElementById('reg-intercept').textContent = intercept.toFixed(4);
            document.getElementById('reg-se').textContent = se.toFixed(4);
            document.getElementById('reg-ttest').textContent = `t(${df}) = ${tStat.toFixed(4)}, p = ${pSlope < 0.0001 ? pSlope.toExponential(2) : pSlope.toFixed(4)}${pSlope < 0.05 ? ' ‚úì' : ''}`;
            document.getElementById('reg-results').classList.add('active');
            
            // Store state for prediction
            _regState = { slope, intercept, se, ssxx, mx: mean(xs), n };

            // Compute residuals
            const residuals = ys.map((y, i) => y - (intercept + slope * xs[i]));

            drawScatterplot(xs, ys, slope, intercept, r);
            drawResidualPlot(xs, residuals);

            // Show prediction section
            document.getElementById('reg-predict-section').style.display = 'block';
        }
        
        function calculateSampleSize() {
            const effect = parseFloat(document.getElementById('ss-effect').value);
            const power = parseFloat(document.getElementById('ss-power').value);
            const alpha = parseFloat(document.getElementById('ss-alpha').value);
            if (isNaN(effect) || effect <= 0) { alert('Please enter a positive effect size'); return; }
            
            const z_alpha = normalInvCDF(1 - alpha / 2);
            const z_beta = normalInvCDF(power);
            const n = Math.ceil(((z_alpha + z_beta) / effect) ** 2);
            
            let interp;
            if (effect < 0.2) interp = 'Very small';
            else if (effect < 0.5) interp = 'Small';
            else if (effect < 0.8) interp = 'Medium';
            else interp = 'Large';
            
            document.getElementById('ss-n').textContent = n;
            document.getElementById('ss-interpretation').textContent = interp;
            document.getElementById('ss-mdd').textContent = `${effect}œÉ (${effect} √ó std dev)`;
            document.getElementById('samplesize-results').classList.add('active');
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Chi-Square Distribution ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function gammaCDF(a, x) {
            // Regularized lower incomplete gamma function P(a, x)
            if (x <= 0) return 0;
            if (x < a + 1) {
                // Series expansion
                let sum = 1/a, term = 1/a;
                for (let n = 1; n < 300; n++) {
                    term *= x / (a + n);
                    sum += term;
                    if (Math.abs(term) < 1e-14 * Math.abs(sum)) break;
                }
                return sum * Math.exp(-x + a * Math.log(x) - lnGamma(a));
            } else {
                // Continued fraction for upper complement
                let f = x - a + 1;
                if (Math.abs(f) < 1e-30) f = 1e-30;
                let c = 1e30, d = 1/f, h = d;
                for (let i = 1; i < 300; i++) {
                    let an = -i * (i - a);
                    let bn = x - a + 1 + 2 * i;
                    d = bn + an * d; if (Math.abs(d) < 1e-30) d = 1e-30;
                    c = bn + an / c; if (Math.abs(c) < 1e-30) c = 1e-30;
                    d = 1/d;
                    let del = d * c;
                    h *= del;
                    if (Math.abs(del - 1) < 1e-14) break;
                }
                return 1 - Math.exp(-x + a * Math.log(x) - lnGamma(a)) * h;
            }
        }
        
        function chiSquarePValue(x, df) {
            if (x <= 0) return 1;
            return 1 - gammaCDF(df / 2, x / 2);
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Paired t-Test ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function calculatePairedT() {
            const pairs = parsePairs(document.getElementById('tp-data').value);
            const tail = document.getElementById('tp-tail').value;
            if (pairs.length < 2) { alert('Need at least 2 paired observations'); return; }
            
            const diffs = pairs.map(p => p[0] - p[1]);
            const n = diffs.length;
            const dMean = mean(diffs);
            const dSD = standardDeviation(diffs);
            const se = dSD / Math.sqrt(n);
            const t = dMean / se;
            const df = n - 1;
            const pValue = tPValue(t, df, tail);
            const cohensD = Math.abs(dMean) / dSD;
            
            // 95% CI for mean difference
            const tCrit = tCritical(df, 0.05);
            const margin = tCrit * se;
            
            const tailLabel = tail === 'two' ? 'two-tailed' : (tail === 'left' ? 'left-tailed' : 'right-tailed');
            
            document.getElementById('tp-n').textContent = n;
            document.getElementById('tp-meandiff').textContent = dMean.toFixed(4);
            document.getElementById('tp-sddiff').textContent = dSD.toFixed(4);
            document.getElementById('tp-stat').textContent = t.toFixed(4);
            document.getElementById('tp-df').textContent = df;
            document.getElementById('tp-pvalue').textContent = `${pValue < 0.0001 ? pValue.toExponential(2) : pValue.toFixed(4)} (${tailLabel})`;
            document.getElementById('tp-result').textContent = pValue < 0.05 ? 'Reject H‚ÇÄ ‚úì' : 'Fail to reject H‚ÇÄ';
            document.getElementById('tp-cohend').textContent = `${cohensD.toFixed(4)} (${cohensD < 0.2 ? 'negligible' : cohensD < 0.5 ? 'small' : cohensD < 0.8 ? 'medium' : 'large'})`;
            document.getElementById('tp-ci').textContent = `[${(dMean - margin).toFixed(4)}, ${(dMean + margin).toFixed(4)}]`;
            document.getElementById('tp-results').classList.add('active');
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Chi-Square Test of Independence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function parseContingencyTable(input) {
            const rows = input.trim().split('\n').filter(r => r.trim());
            return rows.map(row => row.split(/[,\t]+/).map(x => parseFloat(x.trim())).filter(x => !isNaN(x)));
        }
        
        function calculateChiIndependence() {
            const table = parseContingencyTable(document.getElementById('chi-data').value);
            if (table.length < 2) { alert('Need at least 2 rows'); return; }
            const nCols = table[0].length;
            if (nCols < 2) { alert('Need at least 2 columns'); return; }
            if (table.some(r => r.length !== nCols)) { alert('All rows must have the same number of columns'); return; }
            
            const nRows = table.length;
            const rowTotals = table.map(r => r.reduce((a, b) => a + b, 0));
            const colTotals = Array(nCols).fill(0);
            for (let j = 0; j < nCols; j++) {
                for (let i = 0; i < nRows; i++) colTotals[j] += table[i][j];
            }
            const grandTotal = rowTotals.reduce((a, b) => a + b, 0);
            
            // Expected frequencies
            const expected = table.map((row, i) => row.map((_, j) => (rowTotals[i] * colTotals[j]) / grandTotal));
            
            // Chi-square statistic
            let chiSq = 0;
            for (let i = 0; i < nRows; i++) {
                for (let j = 0; j < nCols; j++) {
                    chiSq += (table[i][j] - expected[i][j]) ** 2 / expected[i][j];
                }
            }
            
            const df = (nRows - 1) * (nCols - 1);
            const pValue = chiSquarePValue(chiSq, df);
            const cramersV = Math.sqrt(chiSq / (grandTotal * Math.min(nRows - 1, nCols - 1)));
            
            // Get labels
            const rowLabels = document.getElementById('chi-rowlabels').value.split(',').map(s => s.trim()).filter(Boolean);
            const colLabels = document.getElementById('chi-collabels').value.split(',').map(s => s.trim()).filter(Boolean);
            
            document.getElementById('chi-stat').textContent = chiSq.toFixed(4);
            document.getElementById('chi-df').textContent = df;
            document.getElementById('chi-pvalue').textContent = pValue < 0.0001 ? pValue.toExponential(2) : pValue.toFixed(4);
            document.getElementById('chi-result').textContent = pValue < 0.05 ? 'Reject H‚ÇÄ (variables are associated) ‚úì' : 'Fail to reject H‚ÇÄ (no evidence of association)';
            document.getElementById('chi-cramers').textContent = `${cramersV.toFixed(4)} (${cramersV < 0.1 ? 'negligible' : cramersV < 0.3 ? 'small' : cramersV < 0.5 ? 'medium' : 'large'})`;
            document.getElementById('chi-results').classList.add('active');
            
            // Build observed vs expected tables
            const tablesDiv = document.getElementById('chi-tables');
            let html = '';
            
            // Observed table
            html += buildContingencyHTML('Observed Frequencies', table, rowLabels, colLabels, rowTotals, colTotals, grandTotal, null);
            
            // Expected table
            html += buildContingencyHTML('Expected Frequencies', expected.map(r => r.map(v => parseFloat(v.toFixed(2)))), rowLabels, colLabels, null, null, null, null);
            
            // Contribution table (O-E)¬≤/E
            const contrib = table.map((row, i) => row.map((v, j) => parseFloat(((v - expected[i][j]) ** 2 / expected[i][j]).toFixed(3))));
            html += buildContingencyHTML('Contributions to œá¬≤ ‚Äî (O‚àíE)¬≤/E', contrib, rowLabels, colLabels, null, null, null, 'highlight');
            
            tablesDiv.innerHTML = html;
        }
        
        function buildContingencyHTML(caption, data, rowLabels, colLabels, rowTotals, colTotals, grandTotal, cellClass) {
            const nRows = data.length, nCols = data[0].length;
            let html = '<table class="stat-table"><caption>' + caption + '</caption><thead><tr><th></th>';
            for (let j = 0; j < nCols; j++) {
                html += '<th>' + (colLabels[j] || 'C' + (j+1)) + '</th>';
            }
            if (rowTotals) html += '<th>Total</th>';
            html += '</tr></thead><tbody>';
            
            for (let i = 0; i < nRows; i++) {
                html += '<tr><th>' + (rowLabels[i] || 'R' + (i+1)) + '</th>';
                for (let j = 0; j < nCols; j++) {
                    const cls = cellClass ? ' class="' + cellClass + '"' : '';
                    html += '<td' + cls + '>' + data[i][j] + '</td>';
                }
                if (rowTotals) html += '<td class="total-cell">' + rowTotals[i] + '</td>';
                html += '</tr>';
            }
            
            if (colTotals) {
                html += '<tr><th>Total</th>';
                for (let j = 0; j < nCols; j++) {
                    html += '<td class="total-cell">' + colTotals[j] + '</td>';
                }
                html += '<td class="total-cell">' + grandTotal + '</td></tr>';
            }
            
            html += '</tbody></table>';
            return html;
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Chi-Square Goodness of Fit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function calculateGoodnessOfFit() {
            const obsInput = document.getElementById('gof-observed').value;
            const expInput = document.getElementById('gof-expected').value.trim();
            const labelsInput = document.getElementById('gof-labels').value;
            
            const observed = obsInput.split(',').map(x => parseFloat(x.trim())).filter(x => !isNaN(x));
            if (observed.length < 2) { alert('Need at least 2 categories'); return; }
            
            const k = observed.length;
            const total = observed.reduce((a, b) => a + b, 0);
            let expected;
            
            if (expInput === '') {
                // Uniform distribution
                expected = Array(k).fill(total / k);
            } else {
                expected = expInput.split(',').map(x => {
                    const trimmed = x.trim();
                    // Support fraction notation like "1/6"
                    if (trimmed.includes('/')) {
                        const parts = trimmed.split('/');
                        return parseFloat(parts[0]) / parseFloat(parts[1]);
                    }
                    return parseFloat(trimmed);
                }).filter(x => !isNaN(x));
                
                if (expected.length !== k) { alert('Observed and expected must have the same number of categories'); return; }
                
                // If expected values sum to ~1 (proportions), scale to counts
                const expSum = expected.reduce((a, b) => a + b, 0);
                if (Math.abs(expSum - 1) < 0.01) {
                    expected = expected.map(e => e * total);
                } else if (Math.abs(expSum - total) > 0.5) {
                    // Rescale expected to match observed total
                    expected = expected.map(e => e * total / expSum);
                }
            }
            
            // Chi-square statistic
            let chiSq = 0;
            for (let i = 0; i < k; i++) {
                chiSq += (observed[i] - expected[i]) ** 2 / expected[i];
            }
            
            const df = k - 1;
            const pValue = chiSquarePValue(chiSq, df);
            
            const labels = labelsInput.split(',').map(s => s.trim()).filter(Boolean);
            
            document.getElementById('gof-k').textContent = k;
            document.getElementById('gof-stat').textContent = chiSq.toFixed(4);
            document.getElementById('gof-df').textContent = df;
            document.getElementById('gof-pvalue').textContent = pValue < 0.0001 ? pValue.toExponential(2) : pValue.toFixed(4);
            document.getElementById('gof-result').textContent = pValue < 0.05 ? 'Reject H‚ÇÄ (data does not fit expected) ‚úì' : 'Fail to reject H‚ÇÄ (data fits expected)';
            document.getElementById('gof-results').classList.add('active');
            
            // Build comparison table
            const tableDiv = document.getElementById('gof-table');
            let html = '<table class="stat-table"><caption>Observed vs Expected</caption><thead><tr><th>Category</th><th>Observed</th><th>Expected</th><th>(O‚àíE)¬≤/E</th></tr></thead><tbody>';
            for (let i = 0; i < k; i++) {
                const contrib = ((observed[i] - expected[i]) ** 2 / expected[i]);
                html += '<tr><td>' + (labels[i] || 'Cat ' + (i+1)) + '</td>';
                html += '<td>' + observed[i] + '</td>';
                html += '<td>' + expected[i].toFixed(2) + '</td>';
                html += '<td class="highlight">' + contrib.toFixed(3) + '</td></tr>';
            }
            html += '<tr><td class="total-cell">Total</td><td class="total-cell">' + total + '</td><td class="total-cell">' + expected.reduce((a,b)=>a+b,0).toFixed(2) + '</td><td class="total-cell">' + chiSq.toFixed(3) + '</td></tr>';
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
            
            // Draw bar chart
            drawGofChart(observed, expected, labels);
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        function getChartColors() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            return {
                bar: isDark ? '#7c6aef' : '#4f46e5',
                axis: isDark ? '#6a6a80' : '#94a3b8',
                label: isDark ? '#8890a0' : '#64748b',
                grid: isDark ? 'rgba(106,106,128,0.2)' : 'rgba(148,163,184,0.3)',
                point: isDark ? '#7c6aef' : '#4f46e5',
                pointFill: isDark ? 'rgba(124,106,239,0.6)' : 'rgba(79,70,229,0.6)',
                line: '#ef4444',
                lineLight: 'rgba(239,68,68,0.15)',
            };
        }
        
        function drawHistogram(data) {
            const canvas = document.getElementById('histogram');
            const ctx = canvas.getContext('2d');
            const colors = getChartColors();
            
            canvas.width = canvas.offsetWidth * devicePixelRatio;
            canvas.height = canvas.offsetHeight * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);
            
            const width = canvas.offsetWidth, height = canvas.offsetHeight;
            ctx.clearRect(0, 0, width, height);
            
            const min = Math.min(...data), max = Math.max(...data);
            const bins = Math.max(3, Math.min(15, Math.ceil(1 + 3.322 * Math.log10(data.length))));
            const range = max - min || 1;
            const binWidth = range / bins;
            
            const histogram = Array(bins).fill(0);
            data.forEach(v => { let bin = Math.floor((v - min) / binWidth); if (bin >= bins) bin = bins - 1; histogram[bin]++; });
            const maxCount = Math.max(...histogram);
            
            const pad = { top: 30, right: 20, bottom: 45, left: 50 };
            const cw = width - pad.left - pad.right, ch = height - pad.top - pad.bottom;
            const bw = cw / bins;
            
            // Grid
            ctx.strokeStyle = colors.grid; ctx.lineWidth = 1;
            for (let i = 1; i <= 4; i++) {
                const y = pad.top + ch - (i / 4) * ch;
                ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(width - pad.right, y); ctx.stroke();
                ctx.fillStyle = colors.label; ctx.font = '11px SF Mono, Monaco, monospace'; ctx.textAlign = 'right';
                ctx.fillText(Math.round(maxCount * i / 4), pad.left - 8, y + 4);
            }
            
            // Bars
            histogram.forEach((count, i) => {
                const barH = (count / maxCount) * ch;
                const x = pad.left + i * bw, y = pad.top + ch - barH;
                const r = Math.min(4, bw * 0.3), barW = bw * 0.82, bx = x + (bw - barW) / 2;
                ctx.fillStyle = colors.bar;
                ctx.beginPath();
                if (barH > r * 2) {
                    ctx.moveTo(bx, y + r); ctx.arcTo(bx, y, bx + barW, y, r); ctx.arcTo(bx + barW, y, bx + barW, y + barH, r);
                    ctx.lineTo(bx + barW, pad.top + ch); ctx.lineTo(bx, pad.top + ch);
                } else { ctx.rect(bx, y, barW, barH); }
                ctx.fill();
                
                const binStart = min + i * binWidth;
                ctx.fillStyle = colors.label; ctx.font = '10px SF Mono, Monaco, monospace'; ctx.textAlign = 'center';
                if (bins <= 10 || i % 2 === 0) ctx.fillText(binStart.toFixed(1), x + bw / 2, pad.top + ch + 18);
            });
            
            // Axes
            ctx.strokeStyle = colors.axis; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(pad.left, pad.top); ctx.lineTo(pad.left, pad.top + ch); ctx.lineTo(width - pad.right, pad.top + ch); ctx.stroke();
            
            // Title
            ctx.fillStyle = colors.label; ctx.font = '13px -apple-system, BlinkMacSystemFont, sans-serif'; ctx.textAlign = 'center';
            ctx.fillText(`Histogram (n=${data.length}, ${bins} bins)`, width / 2, 18);
            
            // Mean line
            const m = mean(data);
            const meanX = pad.left + ((m - min) / range) * cw;
            if (meanX > pad.left && meanX < width - pad.right) {
                ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2; ctx.setLineDash([5, 3]);
                ctx.beginPath(); ctx.moveTo(meanX, pad.top); ctx.lineTo(meanX, pad.top + ch); ctx.stroke();
                ctx.setLineDash([]);
                ctx.fillStyle = '#ef4444'; ctx.font = '11px -apple-system, sans-serif'; ctx.textAlign = 'left';
                ctx.fillText(`xÃÑ=${m.toFixed(2)}`, meanX + 4, pad.top + 12);
            }
        }
        
        function drawScatterplot(xs, ys, slope, intercept, r) {
            const canvas = document.getElementById('scatterplot');
            const ctx = canvas.getContext('2d');
            const colors = getChartColors();
            
            canvas.width = canvas.offsetWidth * devicePixelRatio;
            canvas.height = canvas.offsetHeight * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);
            
            const width = canvas.offsetWidth, height = canvas.offsetHeight;
            ctx.clearRect(0, 0, width, height);
            
            const pad = { top: 30, right: 30, bottom: 50, left: 60 };
            const cw = width - pad.left - pad.right, ch = height - pad.top - pad.bottom;
            
            const xMin = Math.min(...xs), xMax = Math.max(...xs);
            const yMin = Math.min(...ys), yMax = Math.max(...ys);
            const xRange = xMax - xMin || 1, yRange = yMax - yMin || 1;
            const xPad = xRange * 0.08, yPad = yRange * 0.08;
            
            const x0 = xMin - xPad, x1 = xMax + xPad;
            const y0 = yMin - yPad, y1 = yMax + yPad;
            
            function toCanvasX(v) { return pad.left + ((v - x0) / (x1 - x0)) * cw; }
            function toCanvasY(v) { return pad.top + ch - ((v - y0) / (y1 - y0)) * ch; }
            
            // Grid
            ctx.strokeStyle = colors.grid; ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = pad.top + (i / 4) * ch;
                ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(width - pad.right, y); ctx.stroke();
                const yVal = y1 - (i / 4) * (y1 - y0);
                ctx.fillStyle = colors.label; ctx.font = '10px SF Mono, Monaco, monospace'; ctx.textAlign = 'right';
                ctx.fillText(yVal.toFixed(1), pad.left - 8, y + 4);
            }
            for (let i = 0; i <= 4; i++) {
                const x = pad.left + (i / 4) * cw;
                ctx.beginPath(); ctx.moveTo(x, pad.top); ctx.lineTo(x, pad.top + ch); ctx.stroke();
                const xVal = x0 + (i / 4) * (x1 - x0);
                ctx.fillStyle = colors.label; ctx.font = '10px SF Mono, Monaco, monospace'; ctx.textAlign = 'center';
                ctx.fillText(xVal.toFixed(1), x, pad.top + ch + 18);
            }
            
            // Regression line
            const lineX0 = x0, lineX1 = x1;
            const lineY0 = intercept + slope * lineX0, lineY1 = intercept + slope * lineX1;
            ctx.strokeStyle = colors.line; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(toCanvasX(lineX0), toCanvasY(lineY0)); ctx.lineTo(toCanvasX(lineX1), toCanvasY(lineY1)); ctx.stroke();
            
            // Points
            for (let i = 0; i < xs.length; i++) {
                const cx = toCanvasX(xs[i]), cy = toCanvasY(ys[i]);
                ctx.fillStyle = colors.pointFill;
                ctx.strokeStyle = colors.point;
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
            }
            
            // Axes
            ctx.strokeStyle = colors.axis; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(pad.left, pad.top); ctx.lineTo(pad.left, pad.top + ch); ctx.lineTo(width - pad.right, pad.top + ch); ctx.stroke();
            
            // Title
            ctx.fillStyle = colors.label; ctx.font = '13px -apple-system, BlinkMacSystemFont, sans-serif'; ctx.textAlign = 'center';
            ctx.fillText(`Scatter Plot (n=${xs.length}, r=${r.toFixed(3)})`, width / 2, 18);
            
            // Axis labels
            ctx.fillStyle = colors.label; ctx.font = '12px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('x', width / 2, height - 5);
            ctx.save(); ctx.translate(15, pad.top + ch/2); ctx.rotate(-Math.PI/2); ctx.fillText('y', 0, 0); ctx.restore();
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ANOVA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function parseGroupData(input) {
            const groups = [];
            const lines = input.trim().split('\n');
            for (const line of lines) {
                const colonIdx = line.indexOf(':');
                if (colonIdx === -1) continue;
                const name = line.slice(0, colonIdx).trim();
                const values = line.slice(colonIdx + 1).split(/[,\t]+/).map(s => parseFloat(s.trim())).filter(v => !isNaN(v));
                if (values.length > 0) groups.push({ name, values });
            }
            return groups;
        }

        function fCDF(x, d1, d2) {
            if (x <= 0) return 0;
            const z = d1 * x / (d1 * x + d2);
            return betaIncomplete(d1 / 2, d2 / 2, z);
        }

        function calculateANOVA() {
            const groups = parseGroupData(document.getElementById('anova-data').value);
            if (groups.length < 2) { alert('Need at least 2 groups'); return; }
            for (const g of groups) {
                if (g.values.length < 2) { alert(`Group "${g.name}" needs at least 2 values`); return; }
            }

            const k = groups.length;
            const allValues = groups.flatMap(g => g.values);
            const N = allValues.length;
            const grandMean = mean(allValues);

            // Group statistics
            const groupStats = groups.map(g => ({
                name: g.name,
                n: g.values.length,
                mean: mean(g.values),
                sd: standardDeviation(g.values),
                min: Math.min(...g.values),
                q1: quartile(g.values, 0.25),
                median: median(g.values),
                q3: quartile(g.values, 0.75),
                max: Math.max(...g.values),
                values: g.values
            }));

            // Sum of squares
            let ssBetween = 0, ssWithin = 0;
            for (const g of groupStats) {
                ssBetween += g.n * (g.mean - grandMean) ** 2;
                for (const v of g.values) {
                    ssWithin += (v - g.mean) ** 2;
                }
            }
            const ssTotal = ssBetween + ssWithin;
            const dfBetween = k - 1;
            const dfWithin = N - k;
            const dfTotal = N - 1;
            const msBetween = ssBetween / dfBetween;
            const msWithin = ssWithin / dfWithin;
            const fStat = msBetween / msWithin;
            const pValue = 1 - fCDF(fStat, dfBetween, dfWithin);
            const eta2 = ssBetween / ssTotal;

            // Display results
            document.getElementById('anova-k').textContent = k;
            document.getElementById('anova-n').textContent = N;
            document.getElementById('anova-f').textContent = `F(${dfBetween}, ${dfWithin}) = ${fStat.toFixed(4)}`;
            document.getElementById('anova-p').textContent = `${pValue < 0.0001 ? pValue.toExponential(2) : pValue.toFixed(4)}${pValue < 0.05 ? ' ‚úì significant' : ''}`;
            document.getElementById('anova-eta2').textContent = `${eta2.toFixed(4)} (${(eta2 * 100).toFixed(1)}% of variance) ‚Äî ${eta2 < 0.01 ? 'negligible' : eta2 < 0.06 ? 'small' : eta2 < 0.14 ? 'medium' : 'large'}`;
            document.getElementById('anova-conclusion').textContent = pValue < 0.05
                ? 'Reject H‚ÇÄ: at least one group mean differs significantly (Œ± = 0.05)'
                : 'Fail to reject H‚ÇÄ: no significant difference between group means (Œ± = 0.05)';
            document.getElementById('anova-results').classList.add('active');

            // ANOVA table
            const tableContainer = document.getElementById('anova-table-container');
            tableContainer.style.display = 'block';
            tableContainer.innerHTML = `
                <table class="stat-table">
                    <caption>ANOVA Table</caption>
                    <thead><tr><th>Source</th><th>SS</th><th>df</th><th>MS</th><th>F</th><th>p</th></tr></thead>
                    <tbody>
                        <tr><td><strong>Between</strong></td><td>${ssBetween.toFixed(4)}</td><td>${dfBetween}</td><td>${msBetween.toFixed(4)}</td><td class="highlight">${fStat.toFixed(4)}</td><td class="highlight">${pValue < 0.0001 ? pValue.toExponential(2) : pValue.toFixed(4)}</td></tr>
                        <tr><td><strong>Within</strong></td><td>${ssWithin.toFixed(4)}</td><td>${dfWithin}</td><td>${msWithin.toFixed(4)}</td><td>‚Äî</td><td>‚Äî</td></tr>
                        <tr class="total-cell"><td><strong>Total</strong></td><td>${ssTotal.toFixed(4)}</td><td>${dfTotal}</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td></tr>
                    </tbody>
                </table>`;

            // Group statistics table
            const groupsContainer = document.getElementById('anova-groups-container');
            groupsContainer.style.display = 'block';
            let groupHTML = '<table class="stat-table"><caption>Group Statistics</caption><thead><tr><th>Group</th><th>n</th><th>Mean</th><th>SD</th><th>Min</th><th>Median</th><th>Max</th></tr></thead><tbody>';
            for (const g of groupStats) {
                groupHTML += `<tr><td><strong>${g.name}</strong></td><td>${g.n}</td><td>${g.mean.toFixed(4)}</td><td>${g.sd.toFixed(4)}</td><td>${g.min.toFixed(2)}</td><td>${g.median.toFixed(2)}</td><td>${g.max.toFixed(2)}</td></tr>`;
            }
            groupHTML += '</tbody></table>';
            groupsContainer.innerHTML = groupHTML;

            // Post-hoc pairwise comparisons (Bonferroni)
            const posthocContainer = document.getElementById('anova-posthoc-container');
            if (pValue < 0.05 && k > 2) {
                const numComparisons = k * (k - 1) / 2;
                const bonferroniAlpha = 0.05 / numComparisons;
                let phHTML = `<table class="stat-table"><caption>Post-Hoc Pairwise Comparisons (Bonferroni, Œ±<sub>adj</sub> = ${bonferroniAlpha.toFixed(4)})</caption><thead><tr><th>Comparison</th><th>Mean Diff</th><th>t</th><th>df</th><th>p</th><th>Sig?</th></tr></thead><tbody>`;

                for (let i = 0; i < k; i++) {
                    for (let j = i + 1; j < k; j++) {
                        const gi = groupStats[i], gj = groupStats[j];
                        const meanDiff = gi.mean - gj.mean;
                        // Pooled within-group variance (MSE) for post-hoc
                        const sePooled = Math.sqrt(msWithin * (1/gi.n + 1/gj.n));
                        const tVal = meanDiff / sePooled;
                        const pairDf = dfWithin;
                        const pairP = tPValue(tVal, pairDf, 'two');
                        const adjP = Math.min(pairP * numComparisons, 1);
                        const sig = adjP < 0.05;
                        phHTML += `<tr><td>${gi.name} vs ${gj.name}</td><td>${meanDiff.toFixed(4)}</td><td>${tVal.toFixed(4)}</td><td>${pairDf}</td><td>${adjP < 0.0001 ? adjP.toExponential(2) : adjP.toFixed(4)}</td><td>${sig ? '‚úì' : '‚Äî'}</td></tr>`;
                    }
                }
                phHTML += '</tbody></table>';
                posthocContainer.innerHTML = phHTML;
                posthocContainer.style.display = 'block';
            } else if (pValue < 0.05 && k === 2) {
                posthocContainer.innerHTML = '<p style="color:var(--text-muted);font-size:13px;padding:8px;">Only 2 groups ‚Äî the F-test result is equivalent to a two-sample t-test.</p>';
                posthocContainer.style.display = 'block';
            } else {
                posthocContainer.innerHTML = '<p style="color:var(--text-muted);font-size:13px;padding:8px;">Post-hoc comparisons not shown (overall ANOVA not significant).</p>';
                posthocContainer.style.display = 'block';
            }

            drawBoxPlot(groupStats);
        }

        function drawBoxPlot(groupStats) {
            const canvas = document.getElementById('boxplot');
            const ctx = canvas.getContext('2d');
            const colors = getChartColors();

            canvas.width = canvas.offsetWidth * devicePixelRatio;
            canvas.height = canvas.offsetHeight * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);

            const width = canvas.offsetWidth, height = canvas.offsetHeight;
            ctx.clearRect(0, 0, width, height);

            const k = groupStats.length;
            const allValues = groupStats.flatMap(g => g.values);
            const globalMin = Math.min(...allValues), globalMax = Math.max(...allValues);
            const range = globalMax - globalMin || 1;
            const yPad = range * 0.1;
            const y0 = globalMin - yPad, y1 = globalMax + yPad;

            const pad = { top: 30, right: 30, bottom: 55, left: 60 };
            const cw = width - pad.left - pad.right, ch = height - pad.top - pad.bottom;
            const groupWidth = cw / k;
            const boxWidth = Math.min(groupWidth * 0.5, 60);

            function toCanvasY(v) { return pad.top + ch - ((v - y0) / (y1 - y0)) * ch; }

            // Grid lines
            ctx.strokeStyle = colors.grid; ctx.lineWidth = 1;
            const nTicks = 5;
            for (let i = 0; i <= nTicks; i++) {
                const y = pad.top + (i / nTicks) * ch;
                ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(width - pad.right, y); ctx.stroke();
                const val = y1 - (i / nTicks) * (y1 - y0);
                ctx.fillStyle = colors.label; ctx.font = '10px SF Mono, Monaco, monospace'; ctx.textAlign = 'right';
                ctx.fillText(val.toFixed(1), pad.left - 8, y + 4);
            }

            // Box plots
            const boxColors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16'];
            for (let i = 0; i < k; i++) {
                const g = groupStats[i];
                const centerX = pad.left + (i + 0.5) * groupWidth;
                const boxLeft = centerX - boxWidth / 2;
                const boxRight = centerX + boxWidth / 2;
                const color = boxColors[i % boxColors.length];

                const q1Y = toCanvasY(g.q1);
                const q3Y = toCanvasY(g.q3);
                const medY = toCanvasY(g.median);
                const minY = toCanvasY(g.min);
                const maxY = toCanvasY(g.max);
                const meanY = toCanvasY(g.mean);

                // Box fill (translucent)
                ctx.fillStyle = color + '22';
                ctx.fillRect(boxLeft, q3Y, boxWidth, q1Y - q3Y);

                // Box border
                ctx.strokeStyle = color; ctx.lineWidth = 2;
                ctx.strokeRect(boxLeft, q3Y, boxWidth, q1Y - q3Y);

                // Median line
                ctx.strokeStyle = color; ctx.lineWidth = 2.5;
                ctx.beginPath(); ctx.moveTo(boxLeft, medY); ctx.lineTo(boxRight, medY); ctx.stroke();

                // Mean marker (diamond)
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.moveTo(centerX, meanY - 4);
                ctx.lineTo(centerX + 4, meanY);
                ctx.lineTo(centerX, meanY + 4);
                ctx.lineTo(centerX - 4, meanY);
                ctx.closePath();
                ctx.fill();

                // Whiskers
                ctx.strokeStyle = color; ctx.lineWidth = 1.5;
                // Lower whisker
                ctx.beginPath(); ctx.moveTo(centerX, q1Y); ctx.lineTo(centerX, minY); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(centerX - boxWidth * 0.25, minY); ctx.lineTo(centerX + boxWidth * 0.25, minY); ctx.stroke();
                // Upper whisker
                ctx.beginPath(); ctx.moveTo(centerX, q3Y); ctx.lineTo(centerX, maxY); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(centerX - boxWidth * 0.25, maxY); ctx.lineTo(centerX + boxWidth * 0.25, maxY); ctx.stroke();

                // Individual data points (jittered)
                ctx.fillStyle = color + '66';
                for (const v of g.values) {
                    const jitter = (Math.random() - 0.5) * boxWidth * 0.3;
                    ctx.beginPath(); ctx.arc(centerX + jitter, toCanvasY(v), 2.5, 0, Math.PI * 2); ctx.fill();
                }

                // Group label
                ctx.fillStyle = colors.label; ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif'; ctx.textAlign = 'center';
                const label = g.name.length > 12 ? g.name.slice(0, 11) + '‚Ä¶' : g.name;
                ctx.fillText(label, centerX, pad.top + ch + 20);
                ctx.font = '10px SF Mono, Monaco, monospace'; ctx.fillStyle = colors.label;
                ctx.fillText(`n=${g.n}`, centerX, pad.top + ch + 35);
            }

            // Axes
            ctx.strokeStyle = colors.axis; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(pad.left, pad.top); ctx.lineTo(pad.left, pad.top + ch); ctx.lineTo(width - pad.right, pad.top + ch); ctx.stroke();

            // Title
            ctx.fillStyle = colors.label; ctx.font = '13px -apple-system, BlinkMacSystemFont, sans-serif'; ctx.textAlign = 'center';
            ctx.fillText(`Box Plot by Group (k=${k}, ‚óÜ = mean, ‚îÄ = median)`, width / 2, 18);
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Regression Enhancements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Store regression state for prediction
        let _regState = null;

        function drawResidualPlot(xs, residuals) {
            const container = document.getElementById('residual-plot-container');
            container.style.display = 'block';
            const canvas = document.getElementById('residualplot');
            const ctx = canvas.getContext('2d');
            const colors = getChartColors();

            canvas.width = canvas.offsetWidth * devicePixelRatio;
            canvas.height = canvas.offsetHeight * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);

            const width = canvas.offsetWidth, height = canvas.offsetHeight;
            ctx.clearRect(0, 0, width, height);

            const pad = { top: 30, right: 30, bottom: 40, left: 60 };
            const cw = width - pad.left - pad.right, ch = height - pad.top - pad.bottom;

            const xMin = Math.min(...xs), xMax = Math.max(...xs);
            const xRange = xMax - xMin || 1;
            const xPad2 = xRange * 0.08;
            const x0 = xMin - xPad2, x1 = xMax + xPad2;

            const absMax = Math.max(...residuals.map(Math.abs)) || 1;
            const yLim = absMax * 1.2;

            function toX(v) { return pad.left + ((v - x0) / (x1 - x0)) * cw; }
            function toY(v) { return pad.top + ch / 2 - (v / yLim) * (ch / 2); }

            // Grid
            ctx.strokeStyle = colors.grid; ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = pad.top + (i / 4) * ch;
                ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(width - pad.right, y); ctx.stroke();
                const val = yLim - (i / 4) * 2 * yLim;
                ctx.fillStyle = colors.label; ctx.font = '10px SF Mono, Monaco, monospace'; ctx.textAlign = 'right';
                ctx.fillText(val.toFixed(1), pad.left - 8, y + 4);
            }

            // Zero line
            ctx.strokeStyle = colors.line; ctx.lineWidth = 1.5; ctx.setLineDash([5, 3]);
            ctx.beginPath(); ctx.moveTo(pad.left, toY(0)); ctx.lineTo(width - pad.right, toY(0)); ctx.stroke();
            ctx.setLineDash([]);

            // Points
            for (let i = 0; i < xs.length; i++) {
                const cx = toX(xs[i]), cy = toY(residuals[i]);
                ctx.fillStyle = colors.pointFill;
                ctx.strokeStyle = colors.point;
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
            }

            // Axes
            ctx.strokeStyle = colors.axis; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(pad.left, pad.top); ctx.lineTo(pad.left, pad.top + ch); ctx.lineTo(width - pad.right, pad.top + ch); ctx.stroke();

            // Title
            ctx.fillStyle = colors.label; ctx.font = '13px -apple-system, BlinkMacSystemFont, sans-serif'; ctx.textAlign = 'center';
            ctx.fillText('Residual Plot (residuals vs x)', width / 2, 18);

            // X axis labels
            for (let i = 0; i <= 4; i++) {
                const x = pad.left + (i / 4) * cw;
                const xVal = x0 + (i / 4) * (x1 - x0);
                ctx.fillStyle = colors.label; ctx.font = '10px SF Mono, Monaco, monospace'; ctx.textAlign = 'center';
                ctx.fillText(xVal.toFixed(1), x, pad.top + ch + 18);
            }
        }

        function predictY() {
            if (!_regState) { alert('Run regression first'); return; }
            const xNew = parseFloat(document.getElementById('reg-predict-x').value);
            if (isNaN(xNew)) { alert('Enter a valid x value'); return; }

            const { slope, intercept, se, ssxx, mx, n } = _regState;
            const yHat = intercept + slope * xNew;
            const df = n - 2;
            const tCrit = tCritical(df, 0.05);

            // Standard error of mean prediction
            const seMean = se * Math.sqrt(1/n + (xNew - mx)**2 / ssxx);
            const ciLow = yHat - tCrit * seMean;
            const ciHigh = yHat + tCrit * seMean;

            // Standard error of individual prediction
            const seInd = se * Math.sqrt(1 + 1/n + (xNew - mx)**2 / ssxx);
            const piLow = yHat - tCrit * seInd;
            const piHigh = yHat + tCrit * seInd;

            document.getElementById('reg-pred-y').textContent = yHat.toFixed(4);
            document.getElementById('reg-pred-ci').textContent = `[${ciLow.toFixed(4)} , ${ciHigh.toFixed(4)}]`;
            document.getElementById('reg-pred-pi').textContent = `[${piLow.toFixed(4)} , ${piHigh.toFixed(4)}]`;
            document.getElementById('reg-predict-result').style.display = 'block';
        }

        function drawGofChart(observed, expected, labels) {
            const canvas = document.getElementById('gof-chart');
            const ctx = canvas.getContext('2d');
            const colors = getChartColors();
            
            canvas.width = canvas.offsetWidth * devicePixelRatio;
            canvas.height = canvas.offsetHeight * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);
            
            const width = canvas.offsetWidth, height = canvas.offsetHeight;
            ctx.clearRect(0, 0, width, height);
            
            const k = observed.length;
            const maxVal = Math.max(...observed, ...expected) * 1.15;
            
            const pad = { top: 35, right: 20, bottom: 55, left: 50 };
            const cw = width - pad.left - pad.right, ch = height - pad.top - pad.bottom;
            const groupWidth = cw / k;
            const barWidth = groupWidth * 0.35;
            
            // Grid
            ctx.strokeStyle = colors.grid; ctx.lineWidth = 1;
            for (let i = 1; i <= 4; i++) {
                const y = pad.top + ch - (i / 4) * ch;
                ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(width - pad.right, y); ctx.stroke();
                ctx.fillStyle = colors.label; ctx.font = '10px SF Mono, Monaco, monospace'; ctx.textAlign = 'right';
                ctx.fillText(Math.round(maxVal * i / 4), pad.left - 8, y + 4);
            }
            
            // Bars
            for (let i = 0; i < k; i++) {
                const groupX = pad.left + i * groupWidth;
                
                // Observed bar
                const obsH = (observed[i] / maxVal) * ch;
                const obsX = groupX + groupWidth * 0.1;
                ctx.fillStyle = colors.bar;
                ctx.fillRect(obsX, pad.top + ch - obsH, barWidth, obsH);
                
                // Expected bar
                const expH = (expected[i] / maxVal) * ch;
                const expX = groupX + groupWidth * 0.1 + barWidth + 2;
                ctx.fillStyle = colors.line;
                ctx.globalAlpha = 0.5;
                ctx.fillRect(expX, pad.top + ch - expH, barWidth, expH);
                ctx.globalAlpha = 1;
                
                // Label
                ctx.fillStyle = colors.label; ctx.font = '11px -apple-system, sans-serif'; ctx.textAlign = 'center';
                const label = labels[i] || 'Cat ' + (i+1);
                ctx.fillText(label.length > 8 ? label.slice(0, 7) + '‚Ä¶' : label, groupX + groupWidth / 2, pad.top + ch + 18);
            }
            
            // Axes
            ctx.strokeStyle = colors.axis; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(pad.left, pad.top); ctx.lineTo(pad.left, pad.top + ch); ctx.lineTo(width - pad.right, pad.top + ch); ctx.stroke();
            
            // Title
            ctx.fillStyle = colors.label; ctx.font = '13px -apple-system, BlinkMacSystemFont, sans-serif'; ctx.textAlign = 'center';
            ctx.fillText('Observed vs Expected Frequencies', width / 2, 18);
            
            // Legend
            const legendX = width - pad.right - 140;
            ctx.fillStyle = colors.bar;
            ctx.fillRect(legendX, pad.top + 2, 12, 12);
            ctx.fillStyle = colors.label; ctx.font = '11px -apple-system, sans-serif'; ctx.textAlign = 'left';
            ctx.fillText('Observed', legendX + 16, pad.top + 12);
            
            ctx.fillStyle = colors.line; ctx.globalAlpha = 0.5;
            ctx.fillRect(legendX, pad.top + 20, 12, 12);
            ctx.globalAlpha = 1;
            ctx.fillStyle = colors.label;
            ctx.fillText('Expected', legendX + 16, pad.top + 30);
        }
        
        function redrawCharts() {
            const input = document.getElementById('data-input').value;
            if (input.trim()) {
                const data = parseData(input);
                if (data.length > 0) drawHistogram(data);
            }
            // Redraw scatterplot + residual plot if regression results exist
            const regEq = document.getElementById('reg-eq').textContent;
            if (regEq !== '-') {
                const pairs = parsePairs(document.getElementById('reg-data').value);
                if (pairs.length >= 3) {
                    const xs = pairs.map(p => p[0]), ys = pairs.map(p => p[1]);
                    const mx = mean(xs), my = mean(ys);
                    let ssxx = 0, ssyy = 0, ssxy = 0;
                    for (let i = 0; i < pairs.length; i++) {
                        ssxx += (xs[i] - mx) ** 2; ssyy += (ys[i] - my) ** 2; ssxy += (xs[i] - mx) * (ys[i] - my);
                    }
                    const slope = ssxy / ssxx, intercept = my - slope * mx, r = ssxy / Math.sqrt(ssxx * ssyy);
                    drawScatterplot(xs, ys, slope, intercept, r);
                    const residuals = ys.map((y, i) => y - (intercept + slope * xs[i]));
                    drawResidualPlot(xs, residuals);
                }
            }
            // Redraw box plot if ANOVA results exist
            const anovaF = document.getElementById('anova-f').textContent;
            if (anovaF !== '-') {
                const groups = parseGroupData(document.getElementById('anova-data').value);
                if (groups.length >= 2) {
                    const groupStats = groups.map(g => ({
                        name: g.name, n: g.values.length, mean: mean(g.values), sd: standardDeviation(g.values),
                        min: Math.min(...g.values), q1: quartile(g.values, 0.25), median: median(g.values),
                        q3: quartile(g.values, 0.75), max: Math.max(...g.values), values: g.values
                    }));
                    drawBoxPlot(groupStats);
                }
            }
        }
        
        window.addEventListener('resize', redrawCharts);
    </script>
</body>
</html>
